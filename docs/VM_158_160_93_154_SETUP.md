# ВМ 158.160.93.154 — настройка и безопасный деплой

**ВМ:** 158.160.93.154  
**Ключ:** `C:\Users\petr2\.ssh\ssh-key-1771526730154\ssh-key-1771526730154`  
**Пользователь:** ubuntu (Yandex Cloud)

---

## Быстрый деплой (рекомендуется)

Из корня проекта в PowerShell:

```powershell
cd c:\01_conf\1002doors
.\scripts\deploy-to-new-vm.ps1
```

Скрипт по умолчанию использует ключ и хост для этой ВМ. Он:
1. Проверяет SSH
2. Первый раз настраивает ВМ (Node 20, PostgreSQL, .env, systemd)
3. Собирает артефакт локально и загружает на ВМ (без npm на ВМ)
4. Ставит Nginx + Fail2ban (порт 80, лимиты, бан по логам)

Опции:
- `-SkipSetup` — ВМ уже настроена, только деплой и безопасность
- `-SkipSecurity` — не применять Nginx/Fail2ban (доступ по порту 3000)

---

## Ручные шаги (если нужен контроль)

### 0. Переменные окружения

```powershell
$env:1002DOORS_SSH_KEY = "C:\Users\petr2\.ssh\ssh-key-1771526730154\ssh-key-1771526730154"
$env:1002DOORS_STAGING_HOST = "ubuntu@158.160.93.154"
```

**Фото и БД в сборке:** в артефакт всегда копируются `public/` (включая `public/uploads`, если папка есть) и Prisma (schema + migrations); после распаковки на ВМ выполняется `prisma migrate deploy`. Если фото лежат отдельно от проекта, задайте путь к папке с uploads (final-filled, products и т.д.):  
`$env:1002DOORS_UPLOADS_PATH = "D:\path\to\uploads"` — её содержимое попадёт в `public/uploads` артефакта.

### 1. Проверка SSH

```powershell
ssh -i $env:1002DOORS_SSH_KEY ubuntu@158.160.93.154 "echo OK"
```

Если видите `OK` — ключ и доступ работают. Иначе: проверьте, что ключ добавлен в метаданные ВМ в Yandex Cloud и в группе безопасности открыт порт 22 (желательно только с вашего IP).

### 2. Первичная настройка ВМ (один раз)

```powershell
.\scripts\setup-new-vm.ps1
```

Устанавливаются: Node.js 20, PostgreSQL, каталог `~/domeo-app`, `.env`, systemd-юнит `domeo-standalone`.

### 3. Деплой приложения

```powershell
.\scripts\deploy-standalone-to-vm.ps1
```

Сборка выполняется только на вашем ПК; на ВМ загружается готовый архив, без `npm install` и лишнего трафика.

### 4. (Опционально) Chromium для экспорта PDF

На ВМ:

```bash
# С ПК скопировать скрипт и выполнить на ВМ
scp -i $env:1002DOORS_SSH_KEY scripts/vm-install-chromium.sh ubuntu@158.160.93.154:~/
ssh -i $env:1002DOORS_SSH_KEY ubuntu@158.160.93.154 "sudo bash ~/vm-install-chromium.sh"
```

Затем добавить в `~/domeo-app/.env` на ВМ (подставьте путь из вывода скрипта, обычно `/usr/bin/chromium-browser`):

```env
PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
```

И перезапустить приложение:

```bash
ssh -i $env:1002DOORS_SSH_KEY ubuntu@158.160.93.154 "sudo systemctl restart domeo-standalone"
```

### 5. Безопасность: Nginx + Fail2ban

```powershell
.\scripts\apply-vm-security.ps1
```

После этого:
- В группе безопасности ВМ откройте порт **80**, закройте **3000** снаружи (доступ только через Nginx).
- Порт **22** оставьте только с вашего IP.

Приложение: **http://158.160.93.154** (порт 80) или **http://158.160.93.154:3000** до закрытия 3000.

---

## Проверка после деплоя

```powershell
# Health через Nginx (после шага 5)
curl -s http://158.160.93.154/api/health

# Или напрямую по 3000 (до закрытия порта)
ssh -i $env:1002DOORS_SSH_KEY ubuntu@158.160.93.154 "curl -s http://localhost:3000/api/health"
```

Логи приложения на ВМ:

```bash
ssh -i $env:1002DOORS_SSH_KEY ubuntu@158.160.93.154 "journalctl -u domeo-standalone -n 50 --no-pager"
```

---

## Если SSH не подключается (Connection timed out)

1. **Yandex Cloud → ВМ** — убедитесь, что ВМ в статусе «Работает».
2. **Группа безопасности ВМ** — входящее правило для порта **22** (SSH): источник — ваш IP или 0.0.0.0/0 для проверки.
3. **Метаданные ВМ** — добавлен ваш SSH-ключ (содержимое `ssh-key-1771526730154.pub` в «Метаданные → SSH-ключи» или при создании ВМ).

Когда SSH заработает, из корня проекта выполните (артефакт уже собран — будет использован готовый или пересоберётся автоматически):

```powershell
$env:1002DOORS_SSH_KEY = "C:\Users\petr2\.ssh\ssh-key-1771526730154\ssh-key-1771526730154"
$env:1002DOORS_STAGING_HOST = "ubuntu@158.160.93.154"
.\scripts\deploy-to-new-vm.ps1
```

Если ВМ уже была настроена ранее (Node, PostgreSQL, .env, systemd), только догрузить приложение и безопасность:

```powershell
$env:1002DOORS_SSH_KEY = "C:\Users\petr2\.ssh\ssh-key-1771526730154\ssh-key-1771526730154"
$env:1002DOORS_STAGING_HOST = "ubuntu@158.160.93.154"
.\scripts\deploy-to-new-vm.ps1 -SkipSetup
```
