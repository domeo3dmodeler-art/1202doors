# ВМ 158.160.93.154 — настройка (прежняя)

**Основная ВМ сейчас:** 158.160.13.144 — см. [VM_158_160_13_144_SETUP.md](./VM_158_160_13_144_SETUP.md).

**ВМ:** 158.160.93.154  
**Ключ:** `C:\Users\petr2\.ssh\ssh-key-1771510238528\ssh-key-1771510238528`  
**Пользователь:** ubuntu (если не меняли в Yandex Cloud)

Скрипт деплоя по умолчанию уже настроен на эту ВМ и ключ.

---

## 1. Проверка SSH

На ПК (PowerShell):

```powershell
ssh -i "C:\Users\petr2\.ssh\ssh-key-1771510238528\ssh-key-1771510238528" ubuntu@158.160.93.154 "echo OK"
```

Если видите `OK` — ключ и доступ работают.

---

## 2. Один раз на ВМ: Node.js, PostgreSQL, каталог, .env, systemd

Подключитесь к ВМ и выполните по шагам.

### 2.1. Node.js 20

```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs
node -v
```

### 2.2. PostgreSQL

```bash
sudo apt update && sudo apt install -y postgresql postgresql-contrib
sudo -u postgres createuser -s domeo_user
# Задайте пароль (подставьте свой вместо your_password):
sudo -u postgres psql -c "ALTER USER domeo_user WITH PASSWORD 'your_password';"
sudo -u postgres createdb -O domeo_user domeo
```

### 2.3. Каталог приложения и .env

```bash
mkdir -p ~/domeo-app ~/1002doors
nano ~/domeo-app/.env
```

Вставьте (подставьте пароль БД и свой JWT_SECRET):

```env
DATABASE_URL="postgresql://domeo_user:your_password@localhost:5432/domeo?schema=public"
NODE_ENV=production
JWT_SECRET=ваш-секрет-не-короче-32-символов
```

Для экспорта PDF позже установите Chrome и добавьте в .env:

```env
PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome-stable
```

Сохраните: Ctrl+O, Enter, Ctrl+X.

### 2.4. Systemd-юнит

```bash
sudo tee /etc/systemd/system/domeo-standalone.service << 'EOF'
[Unit]
Description=Domeo 1002doors (standalone)
After=network.target postgresql.service

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/domeo-app
Environment=NODE_ENV=production
Environment=PORT=3000
Environment=HOSTNAME=0.0.0.0
EnvironmentFile=/home/ubuntu/domeo-app/.env
ExecStart=/usr/bin/node server.js
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable domeo-standalone
```

---

## 3. Деплой с ПК

С вашего ПК из каталога проекта:

```powershell
cd c:\01_conf\1002doors
.\scripts\deploy-standalone-to-vm.ps1
```

Скрипт по умолчанию использует ключ и хост для 158.160.93.154. Он соберёт проект (или используйте `-SkipBuild`, если артефакт уже есть), загрузит архив на ВМ в `~/domeo-app`, распакует и перезапустит приложение.

После первого деплоя на ВМ проверьте:

```bash
sudo systemctl start domeo-standalone
sudo systemctl status domeo-standalone
curl -s http://localhost:3000/api/health
```

---

## 4. Доступ снаружи

- Откройте в группе безопасности ВМ порт **80** (и при необходимости 3000 для прямого доступа).
- Настроить Nginx как reverse proxy (80 → 3000) — по желанию; без Nginx приложение доступно на порту 3000.

Приложение: **http://158.160.93.154:3000** (или через Nginx на 80).
