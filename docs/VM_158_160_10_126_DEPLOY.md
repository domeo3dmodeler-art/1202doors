# ВМ 89.169.181.191 — деплой (рабочее приложение, БД, фото)

**IP:** 89.169.181.191  
**Ключ:** `C:\Users\petr2\.ssh\ssh-key-1771526730154\ssh-key-1771526730154`

## Текущее состояние

- **Приложение:** запущено (systemd `domeo-standalone`), порт 3000.
- **БД:** PostgreSQL, схема применена (`prisma db push`), созданы таблицы. Выполнен seed: пользователи (admin@domeo.ru и др., пароль `Test2025!`), категория «Межкомнатные двери», 3 тестовых товара.
- **Фото:** на ВМ в `~/domeo-app/public/uploads` (~407 MB), в т.ч. `final-filled/doors`.
- **Доступ:** **http://89.169.181.191** (порт 80, через Nginx). Порт 3000 снаружи можно закрыть — трафик идёт через Nginx.

## Точечный деплой (только код, без перекачки фото и БД)

Когда правок по коду много: правите локально, смотрите изменения локально, затем один раз выкатываете только приложение на ВМ. Фото (`public/uploads`) и БД на ВМ не трогаются.

```powershell
$env:1002DOORS_SSH_KEY = "C:\Users\petr2\.ssh\ssh-key-1771526730154\ssh-key-1771526730154"
$env:1002DOORS_STAGING_HOST = "ubuntu@89.169.181.191"
.\scripts\deploy-standalone-to-vm.ps1 -AppOnly
```

- Локально выполняется сборка (standalone).
- В архив **не входят** `public/uploads` (артефакт меньше, быстрее загрузка).
- На ВМ при распаковке текущая папка `public/uploads` сохраняется и после распаковки возвращается на место.
- Миграции БД по-прежнему запускаются (если в артефакте есть prisma); при необходимости можно отключить в скрипте.

Полный деплой (с фото, если задан `1002DOORS_UPLOADS_PATH`) — без флага `-AppOnly`.

## Проверка

```powershell
# Health (через Nginx, порт 80)
curl -s http://89.169.181.191/api/health

# Каталог дверей (могут быть пустые models до синхронизации полного каталога)
curl -s http://89.169.181.191/api/catalog/doors/complete-data
```

## Загрузка полного каталога и фото в БД

Сейчас в БД только тестовые данные из seed. Чтобы поднять полный каталог с привязкой к фото:

1. **Вариант A — синхронизация с локальной БД (рекомендуется)**  
   Если есть заполненная локальная БД (SQLite или PostgreSQL):
   - Настроить `scripts/sync-staging-full.ps1` на хост `89.169.181.191` и ключ выше (или задать `1002DOORS_STAGING_HOST`, `1002DOORS_SSH_KEY`).
   - Либо выполнить перенос данных в PostgreSQL по инструкции в `docs/MIGRATE_SQLITE_TO_VM.md` и при необходимости догнать каталог/фото скриптами синхронизации.

2. **Вариант B — повторный seed (только тестовые данные)**  
   Через туннель к БД на ВМ:
   ```powershell
   # В одном терминале — туннель
   ssh -i "C:\Users\petr2\.ssh\ssh-key-1771526730154\ssh-key-1771526730154" -L 5433:localhost:5432 ubuntu@89.169.181.191 -N
   # В другом — seed
   $env:DATABASE_URL = "postgresql://domeo_user:d0me0Stag1ngPg2025@localhost:5433/domeo?schema=public"
   npx prisma db seed
   ```

## Миграции при следующих деплоях

В репозитории в `prisma/migrations/migration_lock.toml` указан `sqlite`, поэтому `prisma migrate deploy` на ВМ с PostgreSQL не выполняется при деплое. Схему на ВМ нужно обновлять вручную:

```bash
# По SSH на ВМ
cd ~/domeo-app && set -a && . ./.env && set +a && npx prisma db push
sudo systemctl restart domeo-standalone
```

Либо один раз установить Prisma на ВМ (`npm install prisma --no-save` уже выполнялся) и при необходимости снова запускать `npx prisma db push` после обновления кода.

## Доступ только с вашего IP (рекомендуется при обрывах сессии и большом трафике)

Если сторонние подключения обрывают сессию и трафик большой — ограничьте доступ по вашему IP, затем примените скрипты по трафику. Пошагово: **[VM_158_160_10_126_ACCESS_MY_IP_ONLY.md](./VM_158_160_10_126_ACCESS_MY_IP_ONLY.md)**.

Кратко: узнать IP → `.\scripts\show-my-ip.ps1`; в группе безопасности ВМ оставить входящие только **22** и **80** с источника **ваш_IP/32**; затем с ПК выполнить `.\scripts\apply-vm-traffic-fix.ps1 -MyIp "ваш_IP"`.

## Nginx (порт 80)

**Выполнено:** Nginx и Fail2ban установлены и настроены. Приложение доступно по **http://89.169.181.191** (порт 80). В группе безопасности рекомендуется оставить открытым порт 80 и закрыть прямой доступ на порт 3000 снаружи.

## Экспорт PDF

На ВМ установлен Chromium (snap), в `~/domeo-app/.env` задано `PUPPETEER_EXECUTABLE_PATH=/snap/bin/chromium`. После перезапуска приложения экспорт в PDF должен работать. Браузер запускается с аргументами `--no-sandbox`, `--disable-setuid-sandbox` и др. только в контексте приложения (без доступа в сеть из браузера).

## Безопасность и типичные ответы

- **401 на api/orders** — ожидаемо: список заказов доступен только авторизованным пользователям. Не отключайте проверку авторизации.
- **404 на часть фото** (`/uploads/final-filled/doors/...`) — в БД могут быть пути к файлам, которых нет на диске (другое имя после синхронизации или файл не загружался). Проверьте соответствие имён в БД и в `~/domeo-app/public/uploads/final-filled/doors/`.

## Исходящий трафик (122 ГБ и более)

Если в Yandex Cloud виден большой исходящий трафик при отсутствии реальных пользователей, вероятные причины:

1. **Snap (Chromium)** — автообновления snap тянут много трафика.
2. **Сканеры и боты** — массовые запросы к тяжёлым эндпоинтам (`/api/catalog/doors/complete-data`, раздача фото).

**Что сделать:**

1. **Применить скрипты снижения трафика и усиления защиты** (с вашей машины, где есть SSH-ключ):
   ```powershell
   $env:1002DOORS_SSH_KEY = "C:\Users\petr2\.ssh\ssh-key-1771526730154\ssh-key-1771526730154"
   $env:1002DOORS_STAGING_HOST = "ubuntu@89.169.181.191"
   # Опционально: чтобы Fail2ban не банил ваш IP, подставьте свой IP
   .\scripts\apply-vm-traffic-fix.ps1 -MyIp "ваш.публичный.IP"
   ```
   Скрипт отключит автообновления snap и apt, включит жёсткие лимиты Nginx (1–3 req/s) и Fail2ban (бан на 24 ч при превышении).

2. **Группа безопасности Yandex Cloud:** входящие — порт **80** (источник 0.0.0.0/0 или только ваш IP), порт **22** — только ваш IP. Остальные входящие удалить. При необходимости временно открыть 80 только с вашего IP.

3. **Диагностика на ВМ:** установить и смотреть, кто генерирует трафик:
   ```bash
   sudo apt install -y vnstat nethogs
   sudo vnstat   # сводка по трафику
   sudo nethogs  # трафик по процессам (в реальном времени)
   ```

Подробнее: `docs/VM_TRAFFIC_REDUCTION.md`, `docs/VM_TRAFFIC_ATTACK_PROTECTION.md`.

## Полезные команды на ВМ

```bash
# Статус и логи
sudo systemctl status domeo-standalone
journalctl -u domeo-standalone -n 100 --no-pager

# Размер фото
du -sh ~/domeo-app/public/uploads
```
