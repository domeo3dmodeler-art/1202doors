# ВМ 89.169.181.191 — доступ только с вашего IP и снижение трафика

Если сторонние подключения обрывают сессию (сканеры, Fail2ban) и исходящий трафик большой — ограничьте доступ по вашему IP, затем примените скрипты снижения трафика.

---

## Шаг 1. Узнать свой IP

На вашем ПК (в той сети, с которой будете подключаться к ВМ):

```powershell
.\scripts\show-my-ip.ps1
```

Или вручную: откройте в браузере [https://ifconfig.me](https://ifconfig.me) или выполните `(Invoke-WebRequest -UseBasicParsing https://ifconfig.me).Content`.

Запишите IP (например `95.165.12.34`). В группе безопасности нужно будет указать **95.165.12.34/32** (один адрес).

**Важно:** если вы подключаетесь через VPN или у вас динамический IP — после смены IP доступ с ПК пропадёт, пока не добавите новый IP в группу безопасности (или временно откроете 22 с 0.0.0.0/0).

---

## Шаг 2. Группа безопасности: только ваш IP

1. Откройте [консоль Yandex Cloud](https://console.yandex.cloud/) → **VPC** → **Группы безопасности** (или **Compute Cloud** → ВМ **89.169.181.191** → вкладка **Сеть** → группа безопасности).
2. Выберите группу, привязанную к этой ВМ.
3. **Входящие правила** — приведите к такому виду (остальные входящие удалите или отключите):

   | Протокол | Порт    | Источник      | Назначение |
   |----------|---------|---------------|------------|
   | TCP      | 22      | **ВАШ_IP/32** | Любой      |
   | TCP      | 80      | **ВАШ_IP/32** | Любой      |

   Пример: если ваш IP `95.165.12.34`, в поле «Источник» укажите **95.165.12.34/32**.

4. Сохраните группу безопасности.

После этого к ВМ смогут подключаться только запросы с вашего IP. SSH и сайт перестанут быть доступны со стороны сканеров и ботов — сессии не будут обрываться из‑за стороннего трафика, исходящий трафик резко уменьшится.

---

## Шаг 3. Подключиться по SSH и применить скрипты по трафику

С вашего ПК (после того как группа безопасности сохранена):

```powershell
$env:1002DOORS_SSH_KEY = "C:\Users\petr2\.ssh\ssh-key-1771526730154\ssh-key-1771526730154"
$env:1002DOORS_STAGING_HOST = "ubuntu@89.169.181.191"
# Подставьте свой IP, чтобы Fail2ban не банил вас при лимитах
.\scripts\apply-vm-traffic-fix.ps1 -MyIp "ВАШ_IP"
```

Скрипт:
- отключает автообновления **snap** и **apt** (снижает фоновый исходящий трафик);
- настраивает Nginx: жёсткие лимиты запросов (1–3 req/s), блок сканеров по User-Agent;
- настраивает Fail2ban: бан на 24 ч при превышении лимитов.

Если нужно открыть сайт не только для себя (например, для заказчика) — после стабилизации трафика можно добавить в группу безопасности ещё один источник (его IP/32) для порта 80 или временно снова разрешить 80 с 0.0.0.0/0 (риск возврата трафика от сканеров).

---

## Краткий чеклист

- [ ] Узнал свой IP (`.\scripts\show-my-ip.ps1` или ifconfig.me).
- [ ] В группе безопасности ВМ 89.169.181.191: входящие только **22** и **80** с источника **мой_IP/32**.
- [ ] Сохранил группу, подождал 1–2 минуты.
- [ ] Подключился по SSH с ПК, выполнил `.\scripts\apply-vm-traffic-fix.ps1 -MyIp "мой_IP"`.
- [ ] Проверил сайт: http://89.169.181.191 (с того же ПК).

См. также: [VM_158_160_10_126_DEPLOY.md](./VM_158_160_10_126_DEPLOY.md), [VM_TRAFFIC_REDUCTION.md](./VM_TRAFFIC_REDUCTION.md), [EMERGENCY_TRAFFIC_AND_SSH.md](./EMERGENCY_TRAFFIC_AND_SSH.md).
