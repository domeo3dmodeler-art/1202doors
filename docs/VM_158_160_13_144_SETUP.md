# Основная ВМ 158.160.13.144 — настройка и защита от сканеров/трафика

**ВМ:** 158.160.13.144 (реанимирована как основная)  
**Пользователь:** ubuntu  
**Скрипты деплоя/sync** по умолчанию уже указывают на эту ВМ.

### Порядок действий

1. **SSH** — настроить доступ (добавить ключ на ВМ, см. раздел 1). Проверка: `ssh -i <ключ> ubuntu@158.160.13.144 "echo OK"`.
2. **Один раз на ВМ** — Node.js, PostgreSQL, `~/domeo-app`, `~/domeo-app/.env`, systemd (раздел 2).
3. **Деплой с ПК** — `.\scripts\deploy-standalone-to-vm.ps1` (раздел 3).
4. **Защита** — Nginx + Fail2ban и снижение трафика (раздел 4).

---

## 1. SSH-доступ

На ПК задайте ключ и хост (если используете свой ключ):

```powershell
$env:1002DOORS_SSH_KEY = "C:\Users\petr2\.ssh\ssh-key-1771510238528\ssh-key-1771510238528"
$env:1002DOORS_STAGING_HOST = "ubuntu@158.160.13.144"
```

**Проверка:**

```powershell
ssh -i $env:1002DOORS_SSH_KEY ubuntu@158.160.13.144 "echo OK"
```

**Если видите `Permission denied (publickey)`:** на этой ВМ ещё нет ключа, который используют скрипты. Варианты:

- **Вариант А.** Добавить на ВМ публичный ключ, который по умолчанию используют скрипты (чтобы не задавать `1002DOORS_SSH_KEY`). На ПК выполните и скопируйте вывод:
  ```powershell
  Get-Content "C:\Users\petr2\.ssh\ssh-key-1771510238528\ssh-key-1771510238528.pub"
  ```
  Если файла `.pub` нет — сгенерируйте пару в этой папке или добавьте на ВМ ключ из варианта Б. Скопированный публичный ключ добавьте на ВМ: через консоль Yandex Cloud (метаданные ВМ → SSH-ключи) или, если есть доступ по другому ключу, в `~/.ssh/authorized_keys` пользователя ubuntu.

- **Вариант Б.** Подключаться своим ключом (например тем, чей публичный ключ вы давали ранее). Тогда перед каждым деплоем/sync задавайте:
  ```powershell
  $env:1002DOORS_SSH_KEY = "путь\к\вашему\приватному_ключу"
  ```
  Публичный ключ (в одну строку в `authorized_keys` на ВМ):

```
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCYy4RCZRFyfwHE98dV8wwFOS3mux7x/oz6JdPiSOCjyhCPPzT8h0FE6cx2h66a2qUVU/5VS01MwNepyg9t1pCDI0qvJ8X0sNaBAOI58ggYL8niJlEpPOspatK/+g0WOmXBJH7tMaL26biW8BGMzhebuZbGpX5SCvHR7XuoToUYPG6GMt3if53rU0Lc6ctyLhnLfCLWmm2sY6EPVmtvam/JCpEHFzu5d3LsjpUpWhcqYPn7f8frz69QMy1rkr6jS2IA7ZCdpr69SedDAIvkYR/u2VpPFIARA1USL9Etmm85dSH0NJkdYBiI6KjanFWTDBRSX+GiyrtDmWYcL6YDIVaH
```

---

## 2. Один раз на ВМ: Node.js, PostgreSQL, каталоги, .env, systemd

Подключитесь по SSH и выполните по шагам.

### 2.1. Node.js 20

```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs
node -v
```

### 2.2. PostgreSQL

```bash
sudo apt update && sudo apt install -y postgresql postgresql-contrib
sudo -u postgres createuser -s domeo_user
sudo -u postgres psql -c "ALTER USER domeo_user WITH PASSWORD 'your_password';"
sudo -u postgres createdb -O domeo_user domeo
```

### 2.3. Каталоги и .env

```bash
mkdir -p ~/domeo-app ~/1002doors
nano ~/domeo-app/.env
```

Содержимое `.env` (подставьте пароль БД и JWT_SECRET):

```env
DATABASE_URL="postgresql://domeo_user:your_password@localhost:5432/domeo?schema=public"
NODE_ENV=production
JWT_SECRET=ваш-секрет-не-короче-32-символов
```

Для PDF на ВМ: установите Chrome и добавьте `PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome-stable`.

### 2.4. Systemd-юнит

```bash
sudo tee /etc/systemd/system/domeo-standalone.service << 'EOF'
[Unit]
Description=Domeo 1002doors (standalone)
After=network.target postgresql.service

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/domeo-app
Environment=NODE_ENV=production
Environment=PORT=3000
Environment=HOSTNAME=0.0.0.0
EnvironmentFile=/home/ubuntu/domeo-app/.env
ExecStart=/usr/bin/node server.js
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable domeo-standalone
```

---

## 3. Деплой с ПК

Из каталога проекта:

```powershell
cd c:\01_conf\1002doors
.\scripts\deploy-standalone-to-vm.ps1
```

После деплоя на ВМ: `sudo systemctl start domeo-standalone` и проверка `curl -s http://localhost:3000/api/health`.

---

## 4. Защита от сканеров и снижение трафика

На этой ВМ есть проблемы со сканерами и лишним трафиком. Используйте уже описанные меры:

| Задача | Документ / скрипт |
|--------|-------------------|
| **Fail2ban + Nginx** (лимиты, бан по логам) | [APPLY_SECURITY_ON_VM.md](./APPLY_SECURITY_ON_VM.md), скрипт `scripts/apply-vm-security.ps1` |
| **Снижение трафика** (отключить snap/apt автообновления) | [VM_TRAFFIC_REDUCTION.md](./VM_TRAFFIC_REDUCTION.md), скрипт `scripts/vm-reduce-traffic.sh` |
| **Обзор защиты от сканеров** | [SECURITY_AGAINST_SCANNERS.md](./SECURITY_AGAINST_SCANNERS.md) |
| **Группа безопасности** | В консоли Yandex Cloud: порт 80 (и при необходимости 22 только с вашего IP), порт 3000 лучше закрыть снаружи (доступ через Nginx на 80). |

Перед применением скриптов задайте хост на новую ВМ:

```powershell
$env:1002DOORS_STAGING_HOST = "ubuntu@158.160.13.144"
.\scripts\apply-vm-security.ps1
```

Снижение трафика (на ВМ):

```powershell
scp -i $env:1002DOORS_SSH_KEY scripts/vm-reduce-traffic.sh ubuntu@158.160.13.144:~/
ssh -i $env:1002DOORS_SSH_KEY ubuntu@158.160.13.144 "sudo bash ~/vm-reduce-traffic.sh"
```

---

## 5. Итог

- **Приложение:** http://158.160.13.144:3000 (или через Nginx на 80 после настройки).
- Деплой: `.\scripts\deploy-standalone-to-vm.ps1`
- Синхронизация БД/фото: `.\scripts\sync-staging-full.ps1` или `npm run sync:staging`
- Перенос данных с локальной SQLite: [PERENOS_PROSTO.md](./PERENOS_PROSTO.md) (туннель на 158.160.13.144 + миграция).
