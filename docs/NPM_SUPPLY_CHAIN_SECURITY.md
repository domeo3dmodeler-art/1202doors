# Безопасность цепочки поставок npm: вредоносный код в зависимостях

## Такое бывает?

**Да.** Установка библиотек через `npm install` / `npm ci` может привести к выполнению чужого кода на машине. Это не теория, а реальные инциденты.

### Известные атаки (2024–2025)

- **Сентябрь 2025, «Shai-Hulud»:** червь скомпрометировал сотни пакетов на npm. Через кражу учёток разработчиков в пакеты добавляли вредоносный код; при установке собирались токены (GitHub, AWS, Azure и т.д.) и распространялись по другим пакетам.
- **Сентябрь 2025, chalk/debug и др.:** скомпрометированы 18 популярных пакетов (chalk, debug, strip-ansi и т.д.) — сотни миллионов установок в неделю. Через фишинг maintainer’а в пакеты попал обфусцированный код, перехватывающий крипто-транзакции.
- Типичные векторы: **postinstall/preinstall-скрипты** (выполняются при `npm install`), кража учёток maintainer’ов, подмена пакетов.

Итог: при установке зависимостей на ВМ действительно может выполниться вредоносный код, если в цепочке есть скомпрометированный пакет.

---

## Общие практики защиты

### 1. Lockfile и строгая установка

- **Всегда коммитить `package-lock.json`** в репозиторий и не допускать «дрейфа» версий.
- В CI и на сервере использовать **`npm ci`**, а не `npm install`.  
  `npm ci` ставит **только** то, что в lockfile, и падает при расхождении с `package.json`.
- В PR проверять изменения в lockfile: новые транзитивные зависимости и скрипты могут нести риск.

### 2. Отключение скриптов при установке (--ignore-scripts)

- Уязвимый момент — **lifecycle-скрипты** пакетов: `postinstall`, `preinstall`, `install` и т.д. При установке они выполняются с правами пользователя и могут делать что угодно (сеть, файлы, переменные окружения).
- **Митигация:** устанавливать зависимости **без выполнения скриптов**:
  ```bash
  npm ci --ignore-scripts
  ```
  или глобально: `npm config set ignore-scripts true`.
- **Минус:** у части пакетов в `postinstall` — легитимные вещи (сборка нативных модулей, загрузка бинарников). При `--ignore-scripts` их нужно потом запускать вручную (например, `npx prisma generate` в нашем проекте).

### 3. Фиксация версий и задержка обновлений

- В `package.json` по возможности использовать **точные версии** или узкие диапазоны, а не широкие `^`/`~`.
- Не ставить только что вышедшие мажорные/минорные версии «в лоб» — выдержать несколько дней и посмотреть, не появились ли сообщения о компрометации пакета.

### 4. Регулярный аудит и мониторинг

- **`npm audit`** — встроенная проверка известных уязвимостей (в т.ч. по базе с информацией о вредоносных пакетах).
- Дополнительно: Snyk, Socket.dev и аналоги — проверка репутации пакетов, подозрительных скриптов и зависимостей.
- Запускать проверки в CI и при обновлении зависимостей.

### 5. Ограничение прав и изоляция

- В CI/CD и на сервере использовать **минимальные токены** (только чтение registry), без прав на публикацию.
- У maintainer’ов npm-пакетов — строгая 2FA (лучше FIDO), ротация токенов, trusted publishing где возможно.

---

## Что уже хорошо в этом проекте

- Используется **`npm ci`** при деплое на ВМ — установка детерминирована по lockfile.
- **`package-lock.json`** хранится в репозитории — можно проверять изменения и воспроизводить сборку.
- **Один postinstall** в корневом `package.json`: `prisma generate || true` — предсказуемый и свой.

## Что внедрено для защиты

- **На ВМ при деплое** (скрипт `deploy-local-to-staging.ps1` и инструкция в `SETUP_YC_VM_STEP_BY_STEP.md`): установка зависимостей выполняется как **`npm ci --ignore-scripts`**, затем вручную **`npx prisma generate`**. Postinstall/preinstall всех пакетов на ВМ не выполняются.
- **Перед деплоем** (скрипт `pre-deploy-check.ps1`): добавлен шаг **`npm audit`**; при обнаружении проблем выводится предупреждение и ссылка на этот документ.
- **Скрипты в package.json:** `npm run audit` и `npm run audit:fix` для ручной проверки и автоматического исправления по возможности.

---

## Рекомендации для деплоя на ВМ

### Вариант A: Без изменения процесса (минимум)

1. **Перед деплоем локально:**  
   `npm audit`  
   Критичные/высокие — по возможности устранить или принять осознанно.
2. **В PR:** при изменении `package.json` или `package-lock.json` — просматривать diff: новые пакеты и новые блоки `"scripts"` у зависимостей.
3. На ВМ после `npm ci` при желании можно однократно проверить:  
   `npm audit` и просмотр списка установленных пакетов (`npm ls --all`).

### Вариант B: Жёстче — установка без скриптов на ВМ

Чтобы на ВМ при установке зависимостей **вообще не выполнялись** postinstall/preinstall скрипты сторонних пакетов:

1. На ВМ в сценарии деплоя заменить:
   ```bash
   npm ci
   ```
   на:
   ```bash
   npm ci --omit=dev --ignore-scripts
   npx prisma generate
   ```
2. Тогда наш `prisma generate` выполняется вручную, а все остальные lifecycle-скрипты зависимостей (в т.ч. потенциально вредоносные) — не запускаются.
3. **`--omit=dev`** ставит только production-зависимости; у многих postinstall-скриптов — у dev-пакетов (например `napi-postinstall` у unrs-resolver). Для сборки Next.js и запуска приложения dev-зависимости на ВМ не обязательны.

**Важно:** в этом проекте Prisma и часть инструментов сборки — в devDependencies. Если при `npm ci --omit=dev` сборка на ВМ падает (нет prisma, typescript и т.д.), используйте только отключение скриптов: `npm ci --ignore-scripts` и затем `npx prisma generate`. Тогда dev-зависимости остаются, но пост-скрипты всех пакетов не выполняются.

### Вариант C: Проверка скриптов в lockfile

Периодически или при обновлении зависимостей просматривать, у каких пакетов есть скрипты:

```bash
# Какие пакеты имеют install/postinstall/preinstall в lockfile
node -e "
const fs = require('fs');
const lock = JSON.parse(fs.readFileSync('package-lock.json', 'utf8'));
const packages = lock.packages || {};
for (const [path, pkg] of Object.entries(packages)) {
  const scripts = pkg.scripts || {};
  if (Object.keys(scripts).length) console.log(path, scripts);
}
"
```

Подозрительные — незнакомые пакеты с сетевыми вызовами или изменением системы в скриптах.

---

## Краткий чеклист

- [ ] В репозитории закоммичен и обновляется `package-lock.json`.
- [ ] На ВМ и в CI используется `npm ci`, а не `npm install`.
- [ ] Периодически запускается `npm audit` и по возможности устраняются критические/высокие риски.
- [ ] При изменении зависимостей проверяются diff в lockfile и новые скрипты у пакетов.
- [ ] (Опционально) На ВМ: `npm ci --ignore-scripts` + ручной `npx prisma generate` для отключения выполнения скриптов зависимостей.
- [ ] При появлении новостей о компрометации популярного пакета — проверить, не входит ли он в дерево зависимостей (npm ls, audit, Snyk/Socket).

Вредоносный код при установке библиотек на ВМ — реальный риск; перечисленные практики снижают вероятность его выполнения и помогают быстрее обнаружить проблему.
