# Архитектура БД: цвет и фото дверей (канонические правила)

**Главное правило:** Цвет не зависит от размера. Цвет зависит только от **кода модели** и **типа покрытия**. Для каждого цвета должно быть одно фото на комбинацию (модель, покрытие, цвет).

---

## 1. Product (товар)

- Один товар = одна продаваемая позиция: комбинация **модель, стиль, размер (Ш×В), тип покрытия, цвет**, плюс опции (наполнение, реверс и т.д.).
- В `properties_data` обязательно:
  - **Код модели Domeo (Web)** — код модели (источник правды для группировки и фото).
  - **Domeo_Стиль Web** — стиль.
  - **Тип покрытия** — ПВХ, ПЭТ, Эмаль, Шпон.
  - **Цвет/Отделка** — название цвета (должно быть заполнено, иначе вариант не попадёт в конфигуратор).
  - **Ширина/мм**, **Высота/мм** — размеры.

**Важно:** Значение **Цвет/Отделка** для одной и той же модели и типа покрытия должно быть одинаковым для всех размеров. То есть у всех товаров с одной моделью, одним покрытием и одним цветом — одно и то же значение «Цвет/Отделка», независимо от ширины/высоты. Размер от цвета не зависит.

- Количество товаров: много (модели × стили × размеры × покрытия × цвета). Это нормально для прайса и корзины.
- Список **вариантов** покрытий и цветов для конфигуратора строится по уникальным парам (Тип покрытия, Цвет/Отделка) по товарам данной (модель, стиль). Размер в этот список не входит.

---

## 2. PropertyPhoto (фото цветов и обложки модели)

Таблица **property_photos**, свойство для фото по цвету: **Domeo_Модель_Цвет**.

### Формат propertyValue для Domeo_Модель_Цвет

- **Строго три части через `|`:** `Код модели|Тип покрытия|Цвет/Отделка`.
- **Код модели** — именно **Код модели Domeo (Web)** в нижнем регистре (например `domeodoors_base_1`), **не** «Название модели» (типа «Дверное полотно Base 1»).
- В ключе **нет** размеров (ширина, высота). Один цвет = одно фото на (модель, покрытие, цвет).

Примеры правильного значения:

- `domeodoors_base_1|пвх|белый`
- `domeodoors_pearl_6|пэт|белоснежный`

Неправильно:

- Использовать «Название модели» в первой части — API ищет по **коду**.
- Добавлять размер в ключ: `код|покрытие|цвет|700|2000` — так делать нельзя.

Сравнение в коде: `trim` + `toLowerCase` по всему `propertyValue`.

### Обложка модели (не по цвету)

- **propertyName** = `Код модели Domeo (Web)`.
- **propertyValue** = код модели в нижнем регистре (одна часть, без покрытия и цвета).

---

## 3. Откуда что берётся в API

| Что | Источник | Правило |
|-----|----------|--------|
| Список пар (модель, стиль) | Product | Только пары, у которых есть ≥1 товар с этим кодом и стилем |
| Покрытия и цвета по модели | Product | Уникальные пары (Тип покрытия, Цвет/Отделка) по товарам этой (modelKey, style). Размер не участвует |
| Путь к фото цвета | PropertyPhoto `Domeo_Модель_Цвет` | Один ключ: `modelKey\|Тип покрытия\|Цвет` (modelKey = Код модели) |
| Обложка модели | PropertyPhoto | По коду модели, затем по префиксу кода в Domeo_Модель_Цвет |

Полная цепочка: [DOOR_CONFIGURATOR_DATA_RULES.md](./DOOR_CONFIGURATOR_DATA_RULES.md), [DOOR_PHOTOS_CHAIN.md](./DOOR_PHOTOS_CHAIN.md), [FILTER_DOOR_COATINGS_AND_COLORS.md](./FILTER_DOOR_COATINGS_AND_COLORS.md).

---

## 4. Частые ошибки данных

1. **PropertyPhoto с «Название модели» вместо кода**  
   Скрипты вроде `bind-color-folder-to-models.ts` (лист «Цвет» из Excel) могут писать в `propertyValue` первую часть как «Название модели». complete-data ищет по **коду** → фото не находится.  
   **Решение:** хранить и искать только по коду; при импорте из Excel маппить «Название модели» → «Код модели» (как в `import-final-filled.ts`: `modelNameToCode` и `propertyValueByCode = modelCode|...`).

2. **Цвет «привязан» к размеру в PropertyPhoto**  
   Если в ключ фото попали размеры (или созданы отдельные записи на каждый размер), это нарушает правило «одно фото на цвет».  
   **Решение:** в `property_photos` только ключи из трёх частей (код|покрытие|цвет); лишние записи с 4+ частями или дубликаты по (код, покрытие, цвет) — удалить или схлопнуть в одну.

3. **В Product разный Цвет/Отделка для одного и того же (модель, покрытие) у разных размеров**  
   Цвет от размера не зависит; так быть не должно.  
   **Решение:** привести к одному значению Цвет/Отделка для всех размеров одной модели и покрытия (и при необходимости поправить импорт/скрипты).

4. **Пустой Цвет/Отделка у товаров**  
   Тогда варианты цветов для этой модели в complete-data не появятся.  
   **Решение:** заполнять Цвет/Отделка при импорте (например из листа «Цвет» или из «Цены базовые», если там появится колонка цвета).

---

## 5. Импорт и скрипты

- **import-final-filled.ts**: при записи PropertyPhoto из листа «Цвет» использует **код** модели (`modelNameToCode` → `propertyValueByCode = modelCode|coatingType|colorName`). Так и должно быть.
- **bind-color-folder-to-models.ts**: при точечной привязке и при привязке из Excel использует **Название модели** в первой части `propertyValue`. Для совместимости с complete-data эти записи нужно либо не создавать, либо потом переписать на код (скрипт нормализации).

После любых массовых правок — очистить кэш complete-data (DELETE `/api/catalog/doors/complete-data` с авторизацией) и проверить отображение фото и фильтров в конфигураторе.
