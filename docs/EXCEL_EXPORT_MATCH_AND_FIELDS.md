# Экспорт в Excel: сценарии «нет совпадения в БД» и имена полей

## 1. Когда возможно «не найдено подходящих товаров» (matchingProducts.length === 0)

Заказ конфигурируется на основе БД, но экспорт может не найти товар в таких случаях:

### Двери (поиск по модели, покрытие, цвет, ширина, высота)

| Сценарий | Причина |
|----------|--------|
| **Разные строковые представления** | В корзине сохраняется код модели (или название). В БД сопоставление по `Код модели Domeo (Web)`, `Domeo_Название модели для Web` — строгое. Пробелы, регистр, лишние символы дают несовпадение. |
| **Разная логика** | *Исправлено:* оба экспорта используют единый модуль `lib/catalog/product-match.ts` (`getMatchingProducts`) без нормализации, строгое сравнение с БД. Ранее были две реализации — сейчас одна. |
| **Типы размеров** | Ширина/высота в корзине — число, в БД могут быть строка или число. Сравнение через `String(...)` есть, но если в БД пусто или другое значение — не совпадёт. |
| **Цвет** | Сравнение строгое: `item.color` с полем БД (Domeo_Цвет / Цвет/Отделка). Корзина хранит color из БД (getCoatingForCart). Расхождение формата (например RAL в одном месте) даёт несовпадение. |
| **Ручки/ограничители** | Совпадение по `product.id === item.handleId` / `item.limiterId`. Если товар удалён из каталога или ID изменился после создания заказа — совпадения не будет. |
| **Редактирование/импорт** | Ручное изменение `cart_data` в БД, импорт заказа из внешней системы или старые заказы с устаревшими кодами моделей — в корзине могут оказаться значения, которых уже нет в текущем каталоге. |
| **Категория и лимит** | Поиск только по категориям «Межкомнатные двери», «Ручки», «Ограничители». Товар в другой категории не найдётся. В puppeteer есть `take: 10000` — при очень большом каталоге теоретически нужный товар может не попасть в выборку. |
| **Ошибки в properties_data** | Если у товара `properties_data` пустое, не JSON или бросает при парсинге — строка пропускается в цикле, товар не считается совпавшим. |

Итог: при «нормальном» потоке (конфигуратор → корзина → заказ → экспорт) совпадение ожидаемо, но разная нормализация, правки данных и граничные случаи могут дать отсутствие совпадения. Fallback (строка только из корзины) нужен для устойчивости.

---

## 2. Имена полей в БД (properties_data) для экспорта

Используются при заполнении колонок Excel из найденного товара.

### Название модели

- **Основное (обязательное по требованию):** `Название модели`
- В коде ранее использовались как запасные (теперь не использовать для «Название модели»):  
  `Domeo_Название модели для Web`, `МОДЕЛЬ`, `model`

### Цены

- **Цена опт:** `Цена опт`  
  В других скриптах/импорте встречаются также: `Цена оптовая`, `Цена опт (руб)`.
- **Цена РРЦ:** `Цена РРЦ`  
  Для ручек в коде дополнительно подставляют: `Цена розница`.

Итого для экспорта в Excel из БД по найденному товару:
- **Название модели** → только `props['Название модели']`
- **Цена опт** → `props['Цена опт']`
- **Цена РРЦ** → `props['Цена РРЦ']` (для ручек допускается fallback `props['Цена розница']`)

### Остальные поля (для контекста)

| Колонка Excel      | Ключи в properties_data (в порядке приоритета) |
|--------------------|--------------------------------------------------|
| Поставщик          | `Поставщик`                                      |
| Материал/Покрытие  | `Материал/Покрытие`, `Тип покрытия`              |
| Размер 1           | `Ширина/мм`, `Размер 1`, `width`                 |
| Размер 2           | `Высота/мм`, `Размер 2`, `height`                |
| Цвет/Отделка       | `Цвет/Отделка`, `Domeo_Цвет`, `ЦВЕТ`, `color`    |
| Сопоставление модели (внутр.) | `Код модели Domeo (Web)`, `Артикул поставщика`, `Domeo_Название модели для Web`, `Название модели`, `МОДЕЛЬ`, `model` |

Константы полей для цен и названия модели заданы в проекте в:
- `lib/constants/product-properties.ts` (RETAIL_PRICE: `Цена РРЦ`, WHOLESALE_PRICE: `Цена опт`)
- `lib/constants/door-properties.ts` (RETAIL_PRICE: `Цена РРЦ`, WHOLESALE_PRICE: `Цена опт`)
