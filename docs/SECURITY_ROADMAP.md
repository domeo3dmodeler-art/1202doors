# План усиления безопасности проекта

Чеклист и приоритеты по доработке безопасности приложения и инфраструктуры.

---

## Уже сделано

| Область | Что есть |
|--------|----------|
| **Аутентификация** | JWT, bcrypt для паролей, проверка JWT_SECRET (≥32 символов) в production |
| **Авторизация** | Роли (admin, manager, executor, complectator), middleware для страниц и API (requireAuth, requireRole, requirePermission) |
| **Rate limiting** | Логин: 5 попыток / 15 мин; health и complete-data: 60 req/min с IP; загрузки: лимит по количеству |
| **Защита API** | Публичные эндпоинты ограничены по частоте; чувствительные за закрыты requireAuth/requireRole |
| **Секреты** | JWT_SECRET, DATABASE_URL не в коде; .env в .gitignore |
| **БД** | Prisma (параметризованные запросы); $queryRaw с тегированными шаблонами где возможно |
| **Деплой** | Standalone-артефакт без npm на ВМ; рекомендации по группе безопасности и ключу SSH |

---

## Критично (сделать в первую очередь)

### 1. Cookie аутентификации

- **Проблема:** `httpOnly: false`, `secure: false` — токен доступен из JS (риск XSS) и передаётся по HTTP.
- **Решение:** В production: `httpOnly: true`, `secure: true` (и по возможности `sameSite: 'strict'`). В development оставить текущие значения для удобства.
- **Статус:** исправлено в коде (login route).

### 2. Эндпоинт /api/test-env

- **Проблема:** Возвращает факт наличия JWT_SECRET, DATABASE_URL и список переменных с JWT/DATABASE в имени — утечка информации.
- **Решение:** В production не отдавать ответ или возвращать 404; оставить только для development.
- **Статус:** исправлено в коде.

### 3. Security headers (Next.js)

- **Проблема:** Заголовки X-Frame-Options, X-Content-Type-Options, CSP и т.д. есть в nginx, но при работе без nginx их нет.
- **Решение:** Добавить в `next.config.mjs` в `headers()` общие заголовки безопасности для всех ответов (или для страниц).
- **Статус:** добавлено в next.config.mjs.

### 4. Группа безопасности и доступ по IP (инфраструктура)

- Закрыть порт 3000 для 0.0.0.0/0; открыть только для ваших IP (и при необходимости тестировщиков).
- SSH (22) — только с вашего IP или подсети.
- **Документация:** [EMERGENCY_TRAFFIC_AND_SSH.md](./EMERGENCY_TRAFFIC_AND_SSH.md), [SECURITY_AGAINST_SCANNERS.md](./SECURITY_AGAINST_SCANNERS.md).

---

## Важно (следующий этап)

### 5. CORS

- **Сделано:** в production при заданных `ALLOWED_ORIGIN` или `NEXT_PUBLIC_APP_URL` заголовок `Access-Control-Allow-Origin` выставляется в этот origin; иначе `*`. Рекомендуется задать переменную на ВМ.

### 6. Глобальный rate limit на /api/*

- **Сделано:** в middleware для всех запросов к `/api/*` применяется глобальный лимит 400 запросов за 15 минут с одного IP (`globalApiRateLimiter`). В development для localhost не ограничивается.

### 7. Логирование безопасности

- Логировать (без паролей и токенов): неудачные попытки входа, смену ролей, доступ к чувствительным операциям (удаление, массовый экспорт).
- Не логировать: пароли, полные токены, полный DATABASE_URL (достаточно «есть/нет» или маска).

### 8. Загрузка файлов

- Проверка типов и размера (есть в file-validation) — держать и при необходимости ужесточить лимиты.
- Хранить загруженные файлы вне веб-корня отдачи статики или отдавать через контролируемый API с проверкой прав.

---

## Рекомендуется

### 9. Content Security Policy (CSP)

- В next.config добавлен базовый набор заголовков; при появлении инлайн-скриптов или сторонних виджетов CSP нужно будет донастроить (script-src, style-src, connect-src), чтобы не сломать функциональность.

### 10. Зависимости

- Регулярно запускать `npm audit` и устранять критические/высокие риски.
- Деплой артефактом без npm на ВМ уже снижает риски цепочки поставок на сервере.

### 11. Инфраструктура

- **Сделано:** скрипт `scripts/vm-security-setup.sh` для ВМ (Nginx reverse proxy с rate limit + Fail2ban). Применение: `npm run apply:vm-security` или `npm run deploy:secure` (деплой + применение). Инструкция: [APPLY_SECURITY_ON_VM.md](./APPLY_SECURITY_ON_VM.md).
- При наличии домена — рассмотреть Yandex Smart Web Security (WAF) за ALB или Cloudflare.

### 12. Raw SQL

- В коде используется `$queryRawUnsafe` в base.repository и database-optimization; параметры передаются отдельно (параметризация), имена таблиц — внутренние. При добавлении нового кода с raw SQL не подставлять пользовательский ввод в строку запроса, только в параметры.

---

## Чеклист перед production

- [ ] JWT_SECRET задан, не короче 32 символов, не в репозитории.
- [ ] Cookie: httpOnly и secure в production.
- [ ] /api/test-env недоступен или не раскрывает информацию в production.
- [ ] Security headers включены (Next.js или nginx).
- [ ] Группа безопасности: порты 22 и 3000 (или 80/443) только с доверенных IP.
- [ ] Rate limiting на логин и при необходимости на ключевые API.
- [ ] npm audit без критических/высоких уязвимостей или с планом по их закрытию.
- [ ] Логи не содержат паролей и полных секретов.
