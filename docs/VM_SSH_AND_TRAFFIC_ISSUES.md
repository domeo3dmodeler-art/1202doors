# Проблемы после деплоя: SSH-ключ перестаёт работать и большой расход трафика

---

## Что делать сейчас (пошагово)

### Шаг 1. Восстановить доступ по SSH

Если по SSH зайти не получается:

1. Откройте **[консоль Yandex Cloud](https://console.yandex.cloud/)** → Compute Cloud → Виртуальные машины → выберите ВМ **158.160.74.180**.
2. Нажмите **«Подключиться»** (или Serial console) и войдите под пользователем **ubuntu** (пароль, если задавали при создании ВМ).
3. В консоли ВМ выполните (подставьте **вашу** строку публичного ключа целиком):
   ```bash
   mkdir -p ~/.ssh
   echo "ВАША_СТРОКА_ПУБЛИЧНОГО_КЛЮЧА" >> ~/.ssh/authorized_keys
   chmod 700 ~/.ssh
   chmod 600 ~/.ssh/authorized_keys
   ```
   Публичный ключ на ПК: `Get-Content "C:\Users\petr2\.ssh\ssh-key-1771392782781\ssh-key-1771392782781.pub"` (или ваш путь к `.pub`).
4. Подключитесь с ПК **без VPN**: `ssh domeo-yc`. Если заходит — доступ восстановлен.

### Шаг 2. Чтобы SSH не пропадал снова — ключ в метаданных ВМ

1. В консоли Yandex Cloud откройте вашу ВМ → **Изменить** (или «Доступ»).
2. В блоке **SSH-ключи** добавьте ту же строку публичного ключа, что в шаге 1. Сохраните.
3. Тогда при следующей перезагрузке или обновлении метаданных ваш ключ не будет затираться.

### Шаг 3. Снизить расход трафика

1. **Доступ к приложению для тестировщиков**  
   Если проект нужно отдавать на тестирование, порт **3000** лучше оставить открытым для всех (0.0.0.0/0), чтобы заходить могли с любых IP. Ограничивать только своим IP в этом случае не стоит.

2. **Отключить автообновления ОС на ВМ (по желанию)**  
   Уменьшает фоновый трафик на обновления пакетов.  
   После входа по SSH:
   ```bash
   sudo systemctl stop unattended-upgrades
   sudo systemctl disable unattended-upgrades
   ```

3. **Проверить, кто создаёт нагрузку** (когда SSH уже есть; при открытом 3000 часть трафика будет от ботов — это нормально):
   ```bash
   ss -tunap
   cat /proc/net/dev
   journalctl -u domeo-staging -n 100 --no-pager
   ```

### Шаг 4. Дальше: подключаться без VPN и использовать безопасный деплой

- Подключаться к ВМ по SSH **без VPN** (или добавить в группу безопасности IP вашего VPN, если нужен доступ с VPN).
- Деплой уже настроен с **`npm ci --ignore-scripts`** на ВМ — при следующих деплоях скрипты зависимостей выполняться не будут.

**Если решите поднять новую ВМ с нуля и сразу всё сделать правильно** (ключ в метаданных, порт 3000 открыт для тестировщиков, безопасная установка пакетов) — пошаговый чеклист: [NEW_YC_VM_CORRECT_DEPLOY.md](./NEW_YC_VM_CORRECT_DEPLOY.md).

---

## Встраивается ли при деплое стороннее ПО (ограничение SSH, трафик)?

**Проверка репозитория:** в коде и скриптах деплоя **нет** логики, которая при заливке кода на ВМ:
- меняет `~/.ssh/` или `authorized_keys`;
- настраивает sshd, firewall, iptables;
- запускает от root установку системных пакетов или скрытых сервисов.

**Что реально выполняется на ВМ при деплое:**
1. Копирование файлов в `~/1002doors` (или `git pull` / `git reset --hard`).
2. `npm ci` → при этом запускается только **postinstall**: `prisma generate || true` (генерация клиента Prisma, без сети и без доступа к системе).
3. `npm run build` → сборка Next.js (компиляция, без выполнения произвольного кода с диска, который трогает SSH).
4. `sudo systemctl restart domeo-staging` → перезапуск уже настроенного юнита (приложение от пользователя ubuntu, не от root).

Скрипты деплоя (`deploy-local-to-staging.ps1`, `sync-staging-full.ps1`) только отдают команды по SSH и копируют файлы; на ВМ не выполняется установка софта в систему и не трогается конфиг SSH. **Итог: в этом репозитории нет кода, который при деплое ограничивает доступ по SSH или встраивает такое ПО.**

**Откуда может идти трафик с ВМ (без «злого» софта):**
- Первый вызов генерации PDF (экспорт в Excel/PDF) может вызвать загрузку Chromium пакетом `@sparticuz/chromium`, если бинарник ещё не был скачан — это разовый или редкий трафик.
- Входящий трафик от ботов на открытый порт 3000 и ответы приложения.
- Автообновления ОС (unattended-upgrades), если включены.

**Рекомендация для уверенности:** при желании можно один раз после деплоя проверить целостность зависимостей: на ВМ выполнить `npm audit` и просмотреть список установленных пакетов (`npm ls --all`). Подозрительные postinstall-скрипты в зависимостях можно проверить в `package-lock.json` (блоки `scripts` у пакетов).

---

## 1. Почему перестаёт работать SSH-ключ после заливки кода

### Что в нашем коде и скриптах **не** трогает SSH

- Скрипты деплоя (`deploy-local-to-staging.ps1`, `sync-staging-full.ps1`) копируют файлы только в `~/1002doors`, выполняют `npm run build` и `systemctl restart`. Они **не** изменяют `~/.ssh/` или `authorized_keys`.
- В репозитории нет кода, который пишет в `.ssh` или в домашний каталог пользователя.
- `git pull` / `git reset --hard` меняют только файлы внутри `~/1002doors`, не каталог `~/.ssh`.

То есть «заливка кода» сама по себе в нашем проекте не должна удалять или портить ваш ключ.

### Наиболее вероятная причина: ключи из метаданных Yandex Cloud

В Yandex Cloud (и в других облаках) при создании ВМ можно указать SSH-ключи. Они записываются в `~/.ssh/authorized_keys` через **cloud-init** (или аналог).

Если cloud-init запускается снова, он может **перезаписать** `authorized_keys` только теми ключами, что указаны в метаданных ВМ. Ваш ключ, добавленный вручную, при этом пропадает.

Такое может происходить при:

- перезагрузке ВМ;
- обновлении метаданных ВМ в консоли Yandex Cloud;
- периодическом перезапуске cloud-init (зависит от образа и настроек).

Итог: после деплоя вы могли перезапускать ВМ или что-то меняли в консоли — и метаданные «перезаписали» ключи.

### Что сделать

1. **Добавить свой ключ в метаданные ВМ в Yandex Cloud**  
   Консоль Yandex Cloud → Compute Cloud → ВМ → редактирование → блок «Доступ» / «SSH-ключи». Добавьте туда содержимое вашего `id_ed25519.pub` (или `.pub`). Тогда при следующем применении метаданных ваш ключ не пропадёт.

2. **Сохранить ключ вручную и не полагаться только на метаданные**  
   Когда SSH снова заработает (через консоль ВМ или Serial console):
   ```bash
   # Сделать резервную копию
   cp ~/.ssh/authorized_keys ~/.ssh/authorized_keys.backup
   # Добавить вашу строку ключа (подставьте свою)
   echo "ssh-rsa AAAAB3... ваш_публичный_ключ" >> ~/.ssh/authorized_keys
   chmod 600 ~/.ssh/authorized_keys
   ```
   И параллельно добавить тот же ключ в метаданные ВМ (п. 1).

3. **Проверить права**  
   SSH требует строгих прав:
   ```bash
   chmod 700 ~/.ssh
   chmod 600 ~/.ssh/authorized_keys
   ```
   Владелец должен быть пользователь, под которым вы заходите (например `ubuntu`).

4. **Проверить, что именно в authorized_keys**  
   После того как попадёте на ВМ:
   ```bash
   cat ~/.ssh/authorized_keys
   ```
   Если вашей строки нет — её снова перезаписали метаданными; тогда п. 1 обязателен.

---

## 2. Почему сильно расходуется трафик «без использования» ВМ

Под «трафиком» обычно имеется в виду объём входящего/исходящего трафика в консоли Yandex Cloud по ВМ.

### Возможные источники

1. **Входящий трафик: боты и сканеры**  
   Если у ВМ есть публичный IP и открыт порт 3000 (и/или 80/443), боты и сканеры постоянно обращаются к сайту. Каждый запрос — входящий трафик и нагрузка на приложение (БД, ответы). Это может выглядеть как «ВМ не используем, а трафик идёт».

2. **Исходящий трафик: обновления ОС**  
   На Ubuntu по умолчанию может быть включён `unattended-upgrades` (автообновления безопасности). Он периодически качает пакеты из интернета — даёт исходящий (и входящий) трафик.

3. **Исходящий трафик: npm/Node**  
   При `npm ci` / `npm install` скачиваются пакеты. Это разово при деплое. Если деплой делается часто или что-то переустанавливает зависимости — трафик будет повторяться.

4. **Приложение**  
   В нашем коде нет фоновых циклов, которые постоянно ходят во внешние API (есть только периодическая очистка кэшей в памяти раз в 5 минут, без сетевых запросов). Но если какой-то внешний сервис или скрипт постоянно дергает ваш API (например health, complete-data, каталог), то трафик и нагрузка будут даже «без вашего использования».

### Что сделать

1. **Посмотреть, кто создаёт соединения и нагрузку** (когда есть SSH):
   ```bash
   # Топ процессов по CPU
   ps aux --sort=-%cpu | head -15
   # Соединения (кто куда подключается)
   ss -tunap
   # Счётчики трафика по интерфейсам (снять два раза с паузой)
   cat /proc/net/dev
   ```

2. **Ограничить входящий трафик по порту 3000**  
   В группе безопасности Yandex Cloud можно разрешить доступ на порт 3000 не с `0.0.0.0/0`, а только с вашего IP или офисной подсети. Тогда боты с других IP не смогут обращаться к приложению — входящий трафик и нагрузка снизятся.

3. **Отключить или ограничить автообновления** (если не нужны):
   ```bash
   sudo systemctl status unattended-upgrades
   # При необходимости отключить:
   # sudo systemctl disable unattended-upgrades
   ```

4. **Логи приложения**  
   Посмотреть, какие запросы приходят:
   ```bash
   journalctl -u domeo-staging -n 200 --no-pager
   ```
   По путям и частоте можно понять, не бьют ли по API боты или внешние скрипты.

---

## Кратко

| Проблема | Наиболее вероятная причина | Действие |
|----------|----------------------------|----------|
| SSH перестаёт работать после деплоя | Перезапись `authorized_keys` из метаданных Yandex Cloud (перезагрузка/обновление ВМ) | Добавить свой ключ в метаданные ВМ и восстановить ключ в `authorized_keys` при доступе через консоль |
| Большой трафик без явного использования | Входящий трафик от ботов на открытый порт 3000; плюс возможные автообновления ОС | Ограничить доступ к 3000 по IP; при необходимости отключить unattended-upgrades; смотреть логи и `ss`/`/proc/net/dev` |

Если опишете, что именно делаете перед тем как SSH перестаёт работать (только деплой, или ещё перезагрузка/изменения в консоли Yandex), можно сузить причину и дать более точные шаги.
