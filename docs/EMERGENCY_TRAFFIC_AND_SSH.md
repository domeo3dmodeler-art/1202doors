# Экстренные меры: огромный трафик (~100 ГБ/ч) и неработающий SSH

Когда после деплоя на ВМ в Yandex Cloud начинается трафик порядка **100 ГБ/час** и перестаёт работать SSH — действуйте по этому плану.

---

## Почему так происходит

1. **Трафик**  
   Порт 3000 открыт в интернет (0.0.0.0/0). Сканеры и боты находят сервис и бьют по нему. Тяжёлые ответы (например `/api/catalog/doors/complete-data`, раздача фото из `/uploads/`) дают большой входящий + исходящий трафик. При большом числе запросов объём может достигать десятков и сотен ГБ в час.

2. **SSH**  
   Ключ в `~/.ssh/authorized_keys` перезаписывается из **метаданных ВМ** при перезагрузке или обновлении настроек. Если ваш ключ не добавлен в метаданные ВМ в Yandex Cloud — он пропадает.

---

## 1. Сразу: ограничить доступ в Yandex Cloud (группа безопасности)

Чтобы остановить трафик и сохранить возможность зайти по SSH только вам:

1. Откройте [консоль Yandex Cloud](https://console.yandex.cloud/) → **VPC** → **Группы безопасности** (или ВМ → вкладка «Сеть» → группа безопасности).
2. Найдите группу, привязанную к вашей ВМ.
3. **Входящие правила:**
   - **SSH (порт 22):** оставьте только **ваш IP** (или подсеть офиса). Удалите правило с источником `0.0.0.0/0` для порта 22 или замените на ваш IP.
   - **Порт 3000:** замените источник `0.0.0.0/0` на **ваш IP** (или список IP тестировщиков). Если тестировщикам нужен доступ с разных IP — временно можно закрыть 3000 для всех, пока не настроите защиту (см. раздел 4).

Узнать свой IP: в браузере откройте [https://ifconfig.me](https://ifconfig.me) или выполните `curl ifconfig.me`.

После сохранения правил трафик с интернета на 22 и 3000 прекратится для всех, кроме разрешённых IP. Это сразу снизит нагрузку и расход.

---

## 2. Восстановить SSH

Если по SSH зайти уже не получается:

1. Консоль Yandex Cloud → **Compute Cloud** → **Виртуальные машины** → выберите вашу ВМ.
2. Нажмите **«Подключиться»** (или **Serial console**) и войдите под пользователем **ubuntu** (логин/пароль, заданные при создании ВМ).
3. В консоли ВМ выполните (подставьте **вашу** строку публичного ключа целиком):

   ```bash
   mkdir -p ~/.ssh
   echo "ВАША_СТРОКА_ПУБЛИЧНОГО_КЛЮЧА" >> ~/.ssh/authorized_keys
   chmod 700 ~/.ssh
   chmod 600 ~/.ssh/authorized_keys
   ```

   Публичный ключ на ПК (PowerShell):  
   `Get-Content "C:\Users\petr2\.ssh\ssh-key-1771392782781\ssh-key-1771392782781.pub"`  
   (или ваш путь к файлу `.pub`.)

4. **Обязательно добавьте этот же ключ в метаданные ВМ**, чтобы он не пропал снова:  
   ВМ → **Изменить** → блок **«Доступ»** / **SSH-ключи** → вставьте строку публичного ключа → сохраните.

5. Подключитесь с ПК (без VPN, если VPN не добавлен в группу безопасности):  
   `ssh ubuntu@<IP_ВМ>` или ваш алиас (например `ssh domeo-yc`).

---

## 3. Деплой только артефактом (без npm на ВМ)

Чтобы не нагружать ВМ установкой пакетов и не провоцировать лишний трафик и сбои SSH:

- Используйте **деплой standalone**: сборка только на вашем ПК, на ВМ загружается готовый архив.  
- Команда: **`npm run deploy:standalone`** (скрипт `scripts/deploy-standalone-to-vm.ps1`).  
- Подробно: [DEPLOY_STANDALONE_ARTIFACT.md](./DEPLOY_STANDALONE_ARTIFACT.md).

На ВМ при таком деплое **не выполняется** `npm install` / `npm ci` — только распаковка и перезапуск сервиса. Это уменьшает риск перегрузки и потери SSH из-за деплоя.

---

## 4. После восстановления доступа: разобраться с трафиком

По SSH на ВМ выполните:

```bash
# Кто создаёт соединения (исходящие — подозрительно)
ss -tunap

# Счётчики трафика по интерфейсам (снять два раза с интервалом 1–2 мин и сравнить)
cat /proc/net/dev

# Топ процессов по CPU
ps aux --sort=-%cpu | head -15

# Логи приложения (какие запросы приходят)
journalctl -u domeo-staging -n 200 --no-pager
# или для standalone:
journalctl -u domeo-standalone -n 200 --no-pager
```

По выводу можно понять: трафик в основном **входящий** (боты к приложению) или **исходящий** (тогда проверить процессы и открытые порты на компрометацию).

---

## 5. Долгосрочная защита от сканеров и трафика

| Мера | Описание |
|------|----------|
| **Группа безопасности** | SSH (22) и приложение (3000) только с ваших/тестировщиков IP; при необходимости выдать тестировщикам VPN и добавить его IP в группу. |
| **Деплой артефактом** | Всегда использовать `npm run deploy:standalone` — без npm на ВМ. |
| **Ключ в метаданных ВМ** | Один раз добавить ваш SSH-ключ в метаданные ВМ в Yandex Cloud, чтобы он не затирался. |
| **Rate limiting** | В приложении включён лимит запросов для части API (логин, загрузки); для публичных тяжёлых эндпоинтов (health, complete-data) лимиты усилены — см. код. |
| **Nginx перед приложением** | По желанию: поставить Nginx с `limit_req_zone` и лимитами на запросы. |
| **Fail2ban** | По желанию: блокировать IP после множества подозрительных запросов (например к типичным путям сканеров). |

Итог: **сначала** ограничьте доступ в группе безопасности и восстановите SSH с ключом в метаданных; **далее** используйте только деплой артефактом и при необходимости добавьте Nginx/fail2ban и ограничение по IP для тестировщиков.
