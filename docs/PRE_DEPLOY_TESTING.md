# Финальное тестирование перед деплоем

Чеклист и команды для проверки ПО перед выкладкой на staging/production.

---

## 1. Автоматические проверки (запускать локально)

### 1.1 Линт

```bash
npm run lint
```

- **Ожидание:** завершение без ошибок (предупреждения допустимы).
- **При ошибках:** `npm run lint:fix` или исправить вручную.
- **Windows:** `next lint` в Next.js 15 выводит в stderr предупреждение о deprecation; PowerShell может интерпретировать это как ошибку. Если линт по сути прошёл (нет списка ошибок ESLint), можно считать шаг успешным или запускать `npx eslint .` по необходимости.

### 1.2 Проверка типов TypeScript

```bash
npm run type-check
```

- **Ожидание:** `tsc --noEmit` завершается с кодом 0.
- **При ошибках:** исправить типы в указанных файлах.
- **Примечание:** в проекте могут быть ошибки типов в разных модулях (в т.ч. app/, lib/, scripts/). Next.js при сборке использует свой компилятор и может успешно собрать проект даже при падении `tsc --noEmit`. **При деплое ориентируйтесь на успешность `npm run build`.** Исправление всех ошибок type-check — отдельная задача.

### 1.3 Юнит-тесты (Vitest)

```bash
npm run test
```

- **Ожидание:** все тесты зелёные (например: 3 test files, 57 tests passed).
- **Файлы:** `lib/catalog/doors-model-options.test.ts`, `lib/documents/deduplication-client.test.ts`, `lib/price/doors-price-engine.test.ts`, `lib/export/puppeteer-generator.excel.test.ts` (на момент актуализации — 4 файла, 77+ тестов).
- **При падениях:** исправить код или тесты, перезапустить.

### 1.4 Сборка production

```bash
npm run build
```

- **Ожидание:** сборка Next.js завершается без ошибок.
- **Важно (Windows):** при ошибке `EPERM` на `.next/trace`:
  - Закрыть dev-сервер (`npm run dev`) и другие процессы, использующие папку `.next`.
  - Удалить папку `.next`: `Remove-Item -Recurse -Force .next` (PowerShell) и снова запустить `npm run build`.
- **Сборки по окружениям:** `npm run build:staging`, `npm run build:prod` при необходимости.

---

## 2. E2E-тесты (Playwright)

Требуют запущенное приложение и (для полных сценариев) настроенную БД и тестовых пользователей.

### 2.1 Подготовка

- Запустить приложение: `npm run dev` (порт 3000).
- Опционально: тестовая БД и переменные:
  - `TEST_BASE_URL=http://localhost:3000`
  - `TEST_USER_EMAIL`, `TEST_USER_PASSWORD` (для auth.spec)
  - `TEST_COMPLECTATOR_EMAIL`, `TEST_COMPLECTATOR_PASSWORD` и т.д. (для documents.spec).

### 2.2 Запуск E2E

```bash
# Базовый прогон (localhost:3000)
npm run test:e2e

# С UI
npm run test:e2e:ui

# С видимым браузером
npm run test:e2e:headed
```

### 2.3 Наборы E2E

| Файл | Назначение |
|------|------------|
| `e2e/health.spec.ts` | Health check API, проверка БД |
| `e2e/auth.spec.ts` | Вход/выход, неверные данные |
| `e2e/documents.spec.ts` | Клиент, КП из корзины, заказы (требует авторизацию и данные) |

Рекомендация: перед деплоем хотя бы один раз прогнать `npm run test:e2e` при поднятом приложении; health-тесты можно запускать без тестовых пользователей.

---

## 3. Ручная проверка (smoke)

Краткая проверка после деплоя на staging/production.

- [ ] **Health:** `GET /api/health` возвращает 200 и `checks.database.status === 'ok'`.
- [ ] **Главная/лендинг:** открывается без 5xx.
- [ ] **Вход:** страница логина, успешный вход с тестовым пользователем.
- [ ] **Роли:** доступ в кабинеты admin/complectator/executor/manager в соответствии с ролью.
- [ ] **Каталог/двери:** страница каталога (например `/doors`) открывается, корзина доступна.
- [ ] **Заказы:** список заказов открывается, создание заказа из корзины (если есть права).
- [ ] **Уведомления:** колокольчик/страница уведомлений открывается без ошибок.

Команды для health после деплоя:

```bash
npm run health:staging   # staging
npm run health:prod     # production
```

---

## 4. Скрипт «всё в одном» (локально)

Запуск всех автоматических проверок одной командой:

```bash
npm run test:predeploy
```

Или напрямую:

```bash
powershell -ExecutionPolicy Bypass -File scripts/pre-deploy-check.ps1
```

Скрипт по очереди выполняет: lint → type-check → unit tests → build. При падении любого шага выводится сообщение и скрипт завершается с кодом 1. E2E не запускается (запускайте отдельно при поднятом приложении).

---

## 5. Итоговый чеклист перед деплоем

- [ ] `npm run lint` — без ошибок (предупреждения допустимы)
- [ ] `npm run type-check` — без ошибок (если падает только из‑за `scripts/`, можно считать некритично при успешном build)
- [ ] `npm run test` — все юнит-тесты проходят
- [ ] `npm run build` — сборка успешна (при EPERM на Windows — закрыть процессы, удалить `.next`, повторить)
- [ ] E2E (по возможности): `npm run test:e2e` при запущенном приложении
- [ ] Миграции БД: `npm run prisma:migrate:deploy` на целевой среде перед/после деплоя
- [ ] Переменные окружения и секреты на сервере проверены
- [ ] После деплоя: smoke (health, логин, основные страницы и роли)

---

## 6. Полезные команды

| Действие | Команда |
|----------|---------|
| Линт | `npm run lint` |
| Типы | `npm run type-check` |
| Юнит-тесты | `npm run test` |
| E2E | `npm run test:e2e` |
| Сборка | `npm run build` |
| Health staging | `npm run health:staging` |
| Health prod | `npm run health:prod` |
| Миграции (деплой) | `npm run prisma:migrate:deploy` |

---

## 7. Результаты последнего прогона (пример)

| Шаг | Результат | Примечание |
|-----|-----------|------------|
| Lint | ⚠️ | На Windows возможен «ложный» выход из-за deprecation в stderr; проверить вывод вручную. |
| Type-check | ❌ | Много ошибок TS в app/, lib/; на сборку Next.js не влияют. |
| Unit tests | ✅ | 4 files, 77 tests passed (Vitest). |
| Build | ⚠️ | Зависит от окружения: при EPERM на `.next` — закрыть dev/IDE, удалить `.next`, повторить. |

Перед деплоем обязательно: **unit tests** и **build** успешны; E2E — по возможности при поднятом приложении.
