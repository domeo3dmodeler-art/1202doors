# Структура приложения на ВМ (89.169.181.191)

Изучено **внимательно** по факту на сервере.

---

## Корневой каталог: `~/domeo-app`

Приложение на ВМ развёрнуто в `/home/ubuntu/domeo-app`. Рядом есть пустой каталог `~/1002doors`.

| Каталог/файл        | Назначение |
|---------------------|------------|
| `.env`              | Переменные окружения (212 байт) |
| `.git`               | Есть (неполный/мелкий репо) |
| `.next`              | **Сборка Next.js** — полная standalone-сборка |
| `app/`               | **Только 2 исходных файла** (остальное только в сборке) |
| `lib/`               | **Только 2 исходных файла** |
| `node_modules/`     | Полные зависимости (620 подкаталогов) |
| `package.json`, `package-lock.json` | Есть |
| `prisma/`            | Полная схема и миграции |
| `public/`            | Статика: favicon, uploads (ручки и т.д.) |
| `server.js`           | **Точка входа** — standalone production-сервер |
| `logs/`              | Логи (в т.ч. next-dev.log при попытках dev) |
| `domeo-standalone.tar.gz` | Не распакованный архив деплоя (~558 MB) |
| `docs/`, `scripts/`, `migrations/`, `monitoring/`, `seeds/`, `sql/`, `1002/` | Есть, не разбирались детально |

---

## Как запускается приложение

- **Режим:** production, **standalone**.
- **Команда по сути:** `node server.js` (или через systemd unit `domeo-app`, который сейчас inactive).
- **server.js:** задаёт `NODE_ENV=production`, `output: "standalone"`, вызывает `next/dist/server/lib/start-server` с `isDev: false`. Слушает порт из `PORT` (по умолчанию 3000).
- **Используется только сборка:** рантайм читает `.next/` и `server.js`, **не** исходники из `app/` и `lib/` (кроме того, что уже вшито в сборку).

Исходники в `app/` и `lib/` на диске при текущем запуске **не подхватываются** — работают только скомпилированные артефакты в `.next`.

---

## Содержимое `app/` на диске (исходники)

Всего **2 файла**:

```
app/admin/catalog/import/page_fixed.tsx
app/api/catalog/hardware/route.ts
```

Остальных страниц, layout, компонентов и API routes в виде исходников в `app/` **нет**. Вся остальная маршрутизация (admin, catalog, doors, documents, api/* и т.д.) существует только внутри `.next/server/app/`.

---

## Содержимое `lib/` на диске (исходники)

Всего **2 файла**:

```
lib/notifications.ts
lib/pdf/htmlToPdf.ts
```

Остальные модули (configurator, auth, export, security и т.д.) на диске в `lib/` отсутствуют и присутствуют только внутри сборки `.next`.

---

## Сборка `.next`

- **.next/server/app/** — скомпилированные маршруты приложения (94 элемента): страницы (admin, catalog, doors, constructor, documents, quotes, …), API, _not-found, favicon, index и т.д.
- **.next/static/** — статика сборки.
- **.next/server/chunks/** и др. — рантайм Next.

Сборка **полная**: приложение в production обслуживает все роуты из этой сборки, а не из исходников на диске.

---

## Prisma

- **prisma/schema.prisma** и **prisma/migrations/** — присутствуют, структура полная (PostgreSQL и т.д.).

---

## Public и загрузки

- **public/** — есть favicon, icon, HTML-страницы, **public/uploads/** с каталогом ручек (final-filled, 04_Ручки_Завертки и т.д.). Фото ручек доступны по путям вроде `/uploads/...` (и по правилу next — реврайт в `/api/uploads/...`).

---

## Выводы

1. На ВМ — **standalone production**: один раз собранный артефакт (.next + server.js), без полного репо с исходниками.
2. Лежащие в `app/` два файла (в т.ч. `app/api/catalog/hardware/route.ts`) — это, по всей видимости, точечно залитые правки; при текущем способе запуска они **не используются** — рантайм берёт код из `.next`.
3. Чтобы правка (например, `route.ts` для ручек) реально применилась при таком деплое, нужна **пересборка** (локально или на ВМ) и замена артефактов в `.next` (или полный деплой standalone).
4. Вариант «next dev на ВМ» для быстрых правок при **текущей** структуре не подходит: на ВМ нет полного дерева исходников (app/, lib/, components и т.д.), только два файла в app/ и два в lib/. Для dev нужен полный репо и `npm run dev`; тогда push-one-file имел бы смысл.

---

## Рекомендации по правкам

- **Сейчас (standalone на ВМ):** правка кода требует пересборки и деплоя артефакта (standalone или rsync .next + server.js и т.п.).
- **Если нужен быстрый цикл (вариант 1):** на ВМ нужно развернуть **полный репо** (все app/, lib/ и т.д.). Для этого:
  1. Локально: `.\scripts\sync-full-sources-to-vm.ps1` — заливает полное дерево исходников (tar + scp).
  2. На ВМ: `cd ~/domeo-app && npm install` (лучше в screen/tmux — по SSH длинные команды могут обрываться).
  3. Запуск dev: `.\scripts\start-vm-dev.ps1` или на ВМ: `npm run dev`.
  4. Далее: правка локально → `.\scripts\push-one-file-to-vm.ps1 <путь>`.

Либо один раз: `.\scripts\setup-vm-fast-edits.ps1` (без -SkipSync) — он вызовет sync-full-sources при отсутствии rsync, затем npm install и start. Подробнее: `docs/VM_POINT_EDITS.md`.

---

## Память на ВМ (RAM)

- **8 ГБ** — это **вся оперативная память ВМ** (total RAM), а не то, сколько занимает наш проект.
- В `free` строка **used ~3.8 Gi** — это **вся система**: ядро, nginx, наш Node (Next.js), системные сервисы и т.д.
- Один процесс **Node (Next.js)** в production обычно занимает **200–600 МБ** (иногда до ~1 ГБ при тяжёлой нагрузке). То есть наш проект — лишь часть этих ~4 ГБ.
- Итог: проект не занимает 8 ГБ; 8 ГБ — объём RAM у ВМ, из них занято примерно половина всеми процессами вместе.
