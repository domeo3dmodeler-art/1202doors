# Защита ВМ от сканеров и атак (огромный трафик)

При трафике порядка **100 ГБ/час** это не обычные пользователи, а:
- **сканеры** (перебор путей, уязвимостей);
- **DDoS / флуд**;
- или **взломанная ВМ** (ботнет, майнер, утечка данных).

Ниже — что сделать по шагам.

---

## 1. Группа безопасности Yandex Cloud (главное)

Ограничьте входящий доступ только нужными портами и источниками.

1. Откройте **Yandex Cloud Console** → **VPC** → **Группы безопасности** → группа, привязанная к вашей ВМ.
2. **Входящие правила** — оставьте только:
   - **Порт 22 (SSH):** источник — **ваш IP** (например `a.b.c.d/32`). Узнать IP: [2ip.ru](https://2ip.ru) или `curl -s ifconfig.me`.
   - **Порт 80 (HTTP):** источник — `0.0.0.0/0` (если сайт публичный) **или** только ваш IP (если доступ только для вас).
3. **Удалите** все остальные входящие правила (в т.ч. порт 3000 снаружи, если есть).
4. Исходящие можно не трогать (или оставить по умолчанию).

Так вы отрежете весь лишний входящий трафик на уровне облака.

---

## 2. Жёсткая настройка на ВМ (Nginx + Fail2ban)

Скрипт снижает лимиты запросов и банит нарушителей надолго.

**С ПК (PowerShell, из корня проекта):**

Чтобы при атаке не забанило ваш IP, задайте его перед запуском (замените `a.b.c.d` на ваш IP, например с [2ip.ru](https://2ip.ru)):

```powershell
scp -i $env:USERPROFILE\.ssh\ssh-key-1771392782781\ssh-key-1771392782781 scripts/vm-hardening-attack.sh ubuntu@84.201.160.50:~/
ssh -i $env:USERPROFILE\.ssh\ssh-key-1771392782781\ssh-key-1771392782781 ubuntu@84.201.160.50 "MY_IP=a.b.c.d sudo -E bash ~/vm-hardening-attack.sh"
```

**Что делает скрипт:**
- **Nginx:** 3 запроса/сек на IP (общий путь), 1 запрос/сек на тяжёлые API; лимит соединений с одного IP; блок по User-Agent (никто, sqlmap, массовые сканеры и т.п.).
- **Fail2ban:** бан на 24 часа после нескольких срабатываний лимита (503) или после нескольких неудачных попыток SSH.

После применения перезагружать ВМ не обязательно — Nginx и Fail2ban подхватят конфиг.

---

## 3. Проверить ВМ на взлом

Если трафик не снизился или есть подозрение на взлом:

```bash
# Подключиться по SSH, затем:

# Кто много качает (по процессам)
sudo apt install -y nethogs
sudo nethogs

# Незнакомые процессы
ps aux | grep -v '\['
top -c

# Посторонние ключи SSH (должен быть только ваш)
cat ~/.ssh/authorized_keys

# Подозрительные задачи по расписанию
sudo crontab -l
ls -la /etc/cron.d/
cat /etc/cron.d/*

# Слушающие порты (ожидаем 22, 80, 3000 локально)
sudo ss -tlnp
```

Если в `authorized_keys` есть чужие ключи — удалите их. Если в cron или в процессах что-то непонятное — опишите вывод или сделайте дамп и разберите отдельно. При уверенности во взломе лучше пересоздать ВМ из образа и сменить все пароли и ключи.

---

## 4. Если трафик всё ещё огромный

- **Временно:** в группе безопасности разрешите порт 80 **только с вашего IP**. Сайт будет доступен только вам, трафик от сканеров и ботов обрежется.
- **Надолго:** поставьте перед ВМ **Cloudflare** (или другой WAF/DDoS-сервис): домен → Cloudflare → origin на IP ВМ. В Cloudflare включите «Under attack» или жёсткие правила, чтобы большую часть атак они забирали на себя.

---

## 5. Краткий чеклист

| Шаг | Действие |
|-----|----------|
| 1 | В группе безопасности: только 22 (с вашего IP) и 80 (с интернета или только с вашего IP). |
| 2 | На ВМ выполнить `sudo bash vm-hardening-attack.sh` (Nginx + Fail2ban). |
| 3 | Проверить `authorized_keys`, cron, процессы, `nethogs`. |
| 4 | При необходимости — белый список IP на 80 или Cloudflare. |

После шагов 1–2 входящий трафик и запросы к приложению должны резко сократиться.

---

## 6. Почему при трафике перестаёт работать SSH-ключ

### Может ли вредоносный код менять настройки ВМ?

**Да.** Если злоумышленник получил выполнение кода на ВМ (например, через уязвимость в приложении — RCE), он может:

- изменить или очистить `~/.ssh/authorized_keys` (удалить ваш ключ, добавить свой);
- поменять конфиг SSH (`/etc/ssh/sshd_config`);
- добавить задачи в cron, завести своего пользователя, поставить бэкдор.

Поэтому при огромном трафике и «внезапно не работает ключ» имеет смысл проверить ВМ на взлом (раздел 3 выше).

### Другие причины, почему ключ «не работает» при трафике

| Причина | Что проверить |
|--------|----------------|
| **Fail2ban заблокировал ваш IP** | При большом числе запросов к Nginx или попытках входа Fail2ban мог забанить и ваш IP. Через консоль ВМ: `sudo fail2ban-client status sshd` и `status nginx-limit-req`; разбан: `sudo fail2ban-client set sshd unbanip ВАШ_IP`. |
| **Cloud-init перезаписал ключи** | При перезагрузке или обновлении метаданных ВМ cloud-init подставляет в `authorized_keys` только ключи из метаданных. Если там нет вашего ключа или он заменился — ключ «пропадает». Решение: добавить ваш ключ в метаданные ВМ (SSH-ключи) и при необходимости снова прописать его через консоль ВМ. |
| **ВМ перегружена** | При DDoS ВМ может не успевать принимать новые SSH-соединения (таймаут). Попробовать зайти позже или после ограничения трафика в группе безопасности. |

### Что сделать, чтобы ключ не «пропадал» и вас не банило

1. **Порт 22 только с вашего IP** (группа безопасности). Тогда к SSH смогут подключаться только вы; даже при подмене ключа злоумышленник с другого IP не зайдёт.
2. **Ваш ключ обязательно в метаданных ВМ** (SSH-ключи в консоли Yandex Cloud), чтобы cloud-init не затирал его при перезагрузке.
3. **Исключить ваш IP из бана в Fail2ban.** На ВМ в конфиге jail (например в `jail.d/domeo.conf`) добавить `ignoreip = 127.0.0.1/8 ВАШ_IP` для jail `sshd` и при необходимости для nginx, чтобы при атаке вас не забанило.
