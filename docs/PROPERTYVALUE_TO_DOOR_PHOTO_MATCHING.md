# Сопоставление propertyValue с фото из final-filled/doors

Каждая запись PropertyPhoto (свойство `Domeo_Модель_Цвет`) имеет `propertyValue` в формате **код модели|Тип покрытия|Цвет/отделка**, например `base1|ПВХ|Крем софт`. Нужно однозначно связать её с файлом в `public/uploads/final-filled/doors/`.

---

## Варианты

### 1. Автоподбор по логике API (рекомендуется для массовой привязки)

**Скрипт:** `scripts/match-propertyvalue-to-door-photo.ts`

Использует ту же логику поиска файла, что и GET `/api/uploads/[...path]` (раздача фото): по `propertyValue` строится «запрошенное» имя файла `{slug(код)}_{slug(покрытие)}_{slug(цвет)}_cover.png`, затем перебираются варианты (точное совпадение, с/без `_cover`, префиксы `Дверь_` / `Дверное_полотно_`, поиск по префиксу модели). Так в интерфейсе и в БД будет один и тот же файл.

- **Только отчёт:**  
  `npx tsx scripts/match-propertyvalue-to-door-photo.ts`  
  В консоль выводится: сколько записей нашли файл, сколько нет, примеры NOT_FOUND.

- **Отчёт в CSV:**  
  `npx tsx scripts/match-propertyvalue-to-door-photo.ts --out=report.csv`  
  Колонки: `propertyValue`, `currentPath`, `matchedFile`, `status` (OK / DIFF / NEW / NOT_FOUND / SKIP_BAD_VALUE). Можно доработать маппинг вручную и потом обновить БД другим способом.

- **Обновить БД по найденным файлам:**  
  `npx tsx scripts/match-propertyvalue-to-door-photo.ts --update`  
  Для каждой записи, где файл найден, в БД записывается `photoPath = /uploads/final-filled/doors/{имя_файла}`. Сначала лучше запустить без `--update` и проверить отчёт.

- **Проверка без записи:**  
  `npx tsx scripts/match-propertyvalue-to-door-photo.ts --update --dry-run`  
  Логика та же, в БД ничего не меняется.

**Плюсы:** один источник правил с API, массовое обновление.  
**Минусы:** если файл назван не по шаблону, скрипт его не найдёт — такие кейсы обрабатываются вручную (варианты 2 или 3).

---

### 2. Ручное сопоставление через Excel (лист «Цвет», столбец «файл»)

В `1002/final_filled 30.01.xlsx` на листе **«Цвет»** добавить столбец **«файл»** и в каждой строке указать имя файла из папки `final-filled/doors` (например `Дверное_полотно_BASE_1_ПВХ_Крем_софт_cover.png`).

Затем:

```bash
npx tsx scripts/bind-color-folder-to-models.ts [--dry-run]
```

Скрипт читает «Название модели», «Тип покрытия», «Цвет/отделка» и «файл», формирует `propertyValue` как **название модели|тип|цвет** и пишет в PropertyPhoto путь `/uploads/final-filled/doors/{файл}`.

**Важно:** в БД при импорте из этого же Excel (import-final-filled) в `propertyValue` записывается **код модели** (из «Цены базовые»), а не название. То есть привязка по столбцу «файл» в bind-color-folder-to-models использует формат «название|покрытие|цвет»; если в БД уже есть записи с «код|покрытие|цвет», возможны дубли или расхождения. Имеет смысл либо везде перейти на код (вариант 1 + при необходимости ручные правки), либо явно решить, какой ключ считать основным.

**Плюсы:** полный контроль, любые имена файлов.  
**Минусы:** ручная работа, нужно следить за форматом ключа (название vs код).

---

### 3. Точечная привязка (исключения и особые кейсы)

В `scripts/color-folder-binding-data.ts` задаётся массив вручную: модель (название), тип покрытия, цвет, имя файла. Запуск:

```bash
npx tsx scripts/bind-color-folder-to-models.ts --point [--dry-run]
```

Подходит для небольшого числа записей, где автоподбор (вариант 1) не сработал или файл назван нестандартно.

---

### 4. Цепочка: отчёт → правка → обновление БД

1. Запустить автоподбор с выгрузкой:  
   `npx tsx scripts/match-propertyvalue-to-door-photo.ts --out=report.csv`
2. В CSV для строк со статусом NOT_FOUND или DIFF вручную дописать/исправить имя файла в колонке `matchedFile` (или в отдельной колонке «файл для БД»).
3. Написать небольшой скрипт или одноразовую команду, которая читает доработанный CSV и обновляет PropertyPhoto (например через `upsertPropertyPhoto` по `propertyValue` и новому пути).

Так можно комбинировать автоподбор и ручные исключения без правки Excel.

---

## Итог

| Задача | Вариант |
|--------|--------|
| Массово сопоставить все propertyValue с файлами в doors и при желании обновить БД | **1** (match-propertyvalue-to-door-photo.ts, при необходимости --update) |
| Жёстко задать «эта строка Excel → этот файл» | **2** (столбец «файл» + bind-color-folder-to-models) |
| Точечно привязать несколько моделей/цветов | **3** (color-folder-binding-data.ts + --point) |
| Сначала посмотреть, что нашлось, потом доработать вручную | **1** с --out=report.csv, при необходимости **4** |

Логика поиска файла по «запрошенному» имени вынесена в `lib/configurator/door-photo-fallback.ts` и используется и в API раздачи, и в скрипте сопоставления, чтобы результат был одинаковым.
