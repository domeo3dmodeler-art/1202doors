# Как хранятся варианты цветов для моделей дверей

## Связи данных (как всё привязано)

- **Цвет не зависит от размера.** Цвет зависит только от **кода модели** и **типа покрытия**. Подробно: [DOOR_DB_ARCHITECTURE_COLOR_AND_PHOTOS.md](./DOOR_DB_ARCHITECTURE_COLOR_AND_PHOTOS.md).
- В **PropertyPhoto** (фото цветов) ключ должен быть **`Код модели Domeo (Web)|Тип покрытия|Цвет/отделка`** (именно код, не «Название модели»). API complete-data ищет фото по коду. Если в БД записано «Название модели» — фото не найдётся; нормализация: `npx tsx scripts/audit-door-color-photos.ts --fix`.
- В complete-data модели группируются по (modelKey, style); список покрытий и цветов строится из товаров этой пары; фото цвета запрашивается из PropertyPhoto по ключу `modelKey|Тип покрытия|Цвет`.
- В расчёте цены поиск товара идёт по **Код модели**, **Стиль**, **Тип покрытия**, **Цвет/Отделка**, размеры (Название модели в фильтр не входит; у товара оно есть и используется для корзины/экспорта).

## Канонический параметр: **Цвет/Отделка**

В каталоге и в коде единственный источник цвета для товара двери — поле **`Цвет/Отделка`** в `Product.properties_data` (JSON). По нему делается подбор товара при расчёте цены, в корзине и при экспорте.

**`Domeo_Цвет`** — устаревшее поле, не используется; везде применяется только **Цвет/Отделка**.

---

## Текущая структура данных

### 1. Товары дверей (Product)

- Создаются из листа **«Цены базовые»** (импорт final_filled или аналог).
- Одна запись Product = одна строка «Цены базовые»: комбинация **Название модели** + размеры (Ширина/мм, Высота/мм) + **Тип покрытия** + поставщик, цены.
- В `properties_data` при импорте заполняются в том числе:
  - `Код модели Domeo (Web)`, `Название модели`, `Тип покрытия`, `Ширина/мм`, `Высота/мм`
  - `Поставщик`, `Цена опт`, `Цена РРЦ`
- Поле **`Цвет/Отделка`** в текущем импорте из «Цены базовые» **не заполняется**: в этом листе нет колонки «Цвет/отделка», одна строка = один тип покрытия (ПВХ, Эмаль и т.д.), без разбивки по цветам. Поэтому у многих товаров дверей в БД **`Цвет/Отделка` пустой**.

### 2. Варианты цветов для конфигуратора (лист «Цвет»)

- Лист **«Цвет»** содержит строки: Название модели, Тип покрытия, **Цвет/отделка**, ссылки на обложку и галерею.
- При импорте эти данные пишутся в **PropertyPhoto**: значение свойства = `Название модели|Тип покрытия|Цвет/отделка`, к нему привязываются фото. Список цветов для модели в UI конфигуратора строится из этих значений (complete-data и т.д.).
- В сами записи **Product** из листа «Цвет» ничего не записывается: ни `Цвет/Отделка`, ни `Domeo_Цвет`. То есть варианты цветов для модели живут в PropertyPhoto и в логике конфигуратора, но не в properties_data товара.

### 3. Итог

- **В БД** у части товаров дверей поле **Цвет/Отделка** в `properties_data` пустое, потому что импорт «Цены базовые» его не выставляет, а лист «Цвет» только заполняет PropertyPhoto.
- Чтобы подбор по цвету в прайсе и экспорте работал по БД, нужно либо:
  - завести в «Цены базовые» (или в эквивалентном источнике) колонку **Цвет/Отделка** и при импорте записывать её в `properties_data`, либо
  - генерировать/обновлять товары из листа «Цвет» так, чтобы у каждой комбинации (модель + размеры + тип покрытия + цвет) была запись Product с заполненным **Цвет/Отделка**.

До тех пор при поиске по точному совпадению **Цвет/Отделка** товары с пустым полем не совпадут с выбранным в заказе цветом.
