# Данные конфигуратора → заказ → экспорт

**Правило:** Чтобы экспорт Excel (и заказ) был заполнен полностью, **все нужные поля должны собираться в конфигураторе** при выборе опций и при добавлении в корзину. В заказе сохраняется `cart_data` с этими полями; при экспорте они используются вместе с данными из БД.

---

## 1. Откуда что берётся в экспорте

| Поле в Excel | Источник | Правило |
|--------------|----------|--------|
| **Цена опт**, **Цена РРЦ** | **БД** (совпавший товар `properties_data`) | В экспорте подставляются из каталога (props), а не из корзины. Корзина хранит итоговую цену позиции; РРЦ/опт для колонок — из найденного в БД товара. |
| Название модели, Материал/Покрытие, Ширина, Высота, Цвет/Отделка, Толщина, Стиль, Кромка в базе, Наполнение, Стекло (тип) | БД (props) + корзина (fallback) | При совпадении товара в БД — из props; иначе из item (то, что выбрал пользователь). |
| Кромка, Цвет кромки, Реверс, Зеркало, Порог, Наличники, Цвет стекла, Комплект фурнитуры | **Корзина** (item) | То, что пользователь выбрал в конфигураторе. Должно сохраняться в cart_data при добавлении в корзину. |
| Кромка, цена; Зеркало, цена; Порог, цена; Наличники, цена; и т.д. | **Корзина** (item.breakdown) | Разбивка цены из калькулятора. Формируется при расчёте цены и **должна передаваться в корзину** (addToCart) и сохраняться в cart_data. |

Итог: **РРЦ и опт в экспорте — из БД; опции и цены опций — из данных, собранных в конфигураторе и сохранённых в заказе.**

---

## 2. Что должен собирать конфигуратор

При добавлении двери в корзину (addToCart) нужно передавать **все** поля, которые потом попадут в заказ и в экспорт:

- Модель, стиль, покрытие, цвет, размеры (width, height)
- **model_name** — название подмодели из БД (из расчёта цены)
- **matchingVariants** — список подходящих вариантов из БД (из расчёта цены), чтобы экспорт не делал повторный поиск и мог взять РРЦ/опт из БД
- **breakdown** — разбивка цены по опциям (Кромка, Реверс, Зеркало, Порог, Наличники и т.д.) для колонок «X, цена» в Excel
- Кромка: **edge**, **edgeId**, **edgeColorName**
- **reversible**, **mirror**, **threshold**
- **architraveNames** / **optionNames** (названия наличников)
- **optionIds**
- **glassColor**, **hardwareKitName** / **handleName**, **limiterId** / **limiterName**
- **price_opt** (если нужен для отображения; в экспорте Цена опт подставляется из БД)

Схемы, которые принимают эти поля: `documentItemSchema`, `createDocumentRequestSchema`, `generateDocumentItemSchema` (для генерации документа из страницы дверей). Не удалять из схем поля, нужные экспорту.

---

## 3. Цепочка данных

```
Конфигуратор (выбор опций)
    → расчёт цены (breakdown, matchingVariants, model_name)
    → addToCart(item с полным набором полей)
    → корзина (cart_data)
    → создание заказа/счёта (cart_data сохраняется в order/invoice)
    → экспорт Excel: items из cart_data + поиск товара в БД (или matchingVariants)
    → getDoorFieldValue: РРЦ/опт из props (БД), опции и breakdown из item (корзина)
```

Если на каком-то шаге поле не передаётся или не сохраняется, в экспорте соответствующая ячейка будет пустой. Поэтому **все данные для экспорта должны собираться в конфигураторе и проходить по всей цепочке до cart_data**.

---

## 4. Где это реализовано

- **Расчёт цены и breakdown:** `lib/price/doors-price-engine.ts`
- **addToCart с breakdown и matchingVariants:** `app/doors/page.tsx`
- **Схемы элементов документа:** `lib/validation/document.schemas.ts` (`documentItemSchema`, `generateDocumentItemSchema`)
- **Подстановка значений в Excel:** `lib/export/excel-door-fields.ts` (`getDoorFieldValue`); **Цена РРЦ / Цена опт** берутся из `props` (БД), затем fallback на item.
