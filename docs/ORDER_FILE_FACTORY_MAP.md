# Файл заказа для фабрики — структура и связь со схемой БД

Документ описывает формирование файла «ЗАКАЗ» (Excel), который скачивается по кнопке **«Заказ из БД»** в карточке заказа, и как в него попадают данные из БД и корзины.

---

## 1. Откуда берётся файл

- **Кнопка:** «Заказ из БД» в модальном окне заказа (исполнитель/комплектатор).
- **Данные:** из заказа в БД: `cart_data` (JSON корзины), `client_id`, `total_amount`, номер заказа.
- **API:** `POST /api/export/fast` с `type: 'order'`, `format: 'excel'`, `clientId`, `items` (разобранный `cart_data`), `totalAmount`.
- **Генерация:** `lib/export/puppeteer-generator.ts` → `generateExcelOrder()`.

---

## 2. Колонки в Excel (полный набор для фабрики)

**Наименование** (колонка 2) формируется автоматически: для дверей — полный набор выбранных опций (модель, покрытие, цвет, размер, кромка, реверс, зеркало, порог, наличники, фурнитура); для ручек/заверток и ограничителей — явное наименование. Колонки «Наименование у поставщика» и «Артикул поставщика» не используются (устаревшие данные).

| № | Колонка | Источник при совпадении в БД | Источник при отсутствии совпадения (fallback) |
|---|---------|-----------------------------|-----------------------------------------------|
| 1 | № | порядковый номер | порядковый номер |
| 2 | Наименование | полный набор опций двери / ручка / ограничитель (генерируется из item) | то же |
| 3 | Количество | из корзины | из корзины |
| 4 | Цена | из корзины | из корзины |
| 5 | Сумма | из корзины | из корзины |
| 6 | Название модели | Domeo_Название модели для Web / Название модели | из item.model (нормализовано); только для дверей |
| 7 | Цена опт | Product.properties_data['Цена опт'] | item.price_opt |
| 8 | Цена РРЦ | Product.properties_data['Цена РРЦ'] / Цена розница | item.unitPrice |
| 9 | Поставщик | properties_data['Поставщик'] | — |
| 10 | Материал/Покрытие | Материал/Покрытие / Тип покрытия | item.finish |
| 11 | Размер 1 | Ширина/мм | item.width |
| 12 | Размер 2 | Высота/мм | item.height |
| 13 | Размер 3 | Толщина/мм | — |
| 14 | Цвет/Отделка | Цвет/Отделка / Domeo_Цвет | item.color |
| 15 | SKU внутреннее | properties_data['SKU внутреннее'] | item.sku_1c |
| 16 | Кромка | — (из корзины) | item.edge === 'да' ? 'да' : '' (для дверей) |
| 17 | Цвет кромки | — (из корзины) | item.edgeColorName / item.edge_color_name; если кромка «да» и нет названия — «—» |
| 18 | Реверс | — (из корзины) | item.reversible ? 'да' : '' (для дверей) |
| 19 | Зеркало | — (из корзины) | Без зеркала / Одна сторона / Две стороны (из item.mirror: one, mirror_one, both, mirror_both) |
| 20 | Цвет стекла | — (из корзины) | item.glassColor / item.glass_color (для дверей) |
| 21 | Порог | — (из корзины) | item.threshold ? 'да' : '' (для дверей) |
| 22 | Наличники | — (из корзины) | item.optionIds?.length ? 'да' : '' (для дверей) |

При **найденном в БД** товаре колонки 6–15 заполняются из `Product.properties_data` (Название модели, Цена опт, РРЦ, Поставщик, Материал/Покрытие, размеры, Цвет, SKU); колонки 16–22 (Кромка, Цвет кромки, Реверс, Зеркало, Цвет стекла, Порог, Наличники) заполняются из корзины (item). Выводятся **все найденные варианты** (по одной строке на каждый вариант), чтобы исполнитель мог выбрать поставщика. При **отсутствии совпадения** колонки 6–8, 10–15 и 16–22 заполняются из корзины (fallback); Цена опт и РРЦ — для всех строк.

---

## 3. Сопоставление позиции корзины с товаром в БД

- **Двери:** по модели, покрытию, цвету, ширине, высоте. Загружаются товары категории «Межкомнатные двери», перебор по `properties_data` с нормализацией:
  - модель: без префикса "DomeoDoors"/"DorneoDoors", сравнение с `Код модели Domeo (Web)`, `Domeo_Название модели для Web`;
  - цвет: без суффикса " (RAL ...)", сравнение с `Цвет/Отделка`, `Domeo_Цвет`.
- **Ручки/завертки:** по `handleId` — загрузка по ID (`findHandleById`), категория «Ручки».
- **Ограничители:** по `limiterId` — загрузка категории «Ограничители», выбор товара по совпадению `product.id === item.limiterId`.

Поля корзины для экспорта (и в `cart_data`): `model`, `finish`, `color`, `width`, `height`, `type`, `handleId`, `handleName`, `limiterId`, `limiterName`, `sku_1c`, `style`, `hardware`, `hardwareKitName`, опции двери `edge`, `edgeColorName` (цвет кромки), `glassColor` (цвет стекла), `reversible`, `mirror` (one/mirror_one/both/mirror_both для «Одна сторона»/«Две стороны»), `threshold`, `optionIds`, плюс `name`, `qty`, `unitPrice`.

---

## 4. Схема БД, релевантная для файла заказа

- **Order:** `cart_data` (JSON), `client_id`, `total_amount`, `number`, дата.
- **Client:** `firstName`, `lastName`, `middleName`, `phone`, `address` — в шапку Excel.
- **Product (каталог):** `properties_data` (JSON) с ключами из таблицы выше (Цена опт, Цена РРЦ, Поставщик, Материал/Покрытие, Размер 1/2/3, Цвет/Отделка, SKU внутреннее и др. — см. `docs/DOOR_ATTRIBUTES_MAP.md`).

Файл заказа не меняет БД; он только читает заказ, клиента и каталог.

---

## 5. Рекомендации для «полного набора данных для заказа двери на фабрике»

1. **В каталоге (Product.properties_data)** заполнять для дверей: Цена опт, Цена РРЦ, Поставщик, Материал/Покрытие, Размеры, Цвет/Отделка, SKU внутреннее — тогда при совпадении позиции все колонки для фабрики заполнятся из БД.
2. **В корзине при создании заказа** сохранять в `cart_data` полный набор полей (model, finish, color, width, height, type, handleId, limiterId, edge, reversible, mirror, threshold, optionIds, hardware и т.д.), чтобы в Excel выводились полные опции двери, ручки, ограничители и все варианты из БД для выбора поставщика.
3. **Номер документа в файле:** берётся из заказа (например `Order-1771133783415` или `Заказ-XXX`); дата — дата формирования файла.

После этих доработок файл «ЗАКАЗ» по кнопке «Заказ из БД» даёт полный набор колонок для фабрики: при наличии совпадения с БД — из каталога, при отсутствии — размеры, цвет, покрытие и цена из корзины.

---

## 6. Сценарии: одна дверь в корзине — несколько вариантов в БД

Одному **коду модели** (Код модели Domeo (Web)) в каталоге может соответствовать **несколько записей Product** в БД: разные размеры, покрытия, цвета, поставщики. Ниже — когда одна позиция в корзине даёт несколько строк/вариантов в файле заказа.

### 6.1 Как устроен каталог

- **API конфигуратора** (`/api/catalog/doors/complete-data`): группировка идёт по **Код модели Domeo (Web)** (modelKey). На UI для удобства это отображается как «модель»; под капотом везде используется **код модели**. В одну «модель» входят все товары с этим кодом — с разными размерами, Тип покрытия, Цвет/Отделка, Поставщик и т.д. С кодом в БД связаны товары; у них в Excel выводится **Название модели** (поле из БД) — человекочитаемое название для экспорта.
- В интерфейсе пользователь выбирает одну дверь: модель + покрытие + цвет + размер. В корзину попадает **одна позиция** с полной конфигурацией (model = код модели, finish, color, width, height).

То есть в корзине хранится не только «код двери», но и конкретная конфигурация (размер, покрытие, цвет). Поиск при экспорте идёт по полному набору: модель + покрытие + цвет + ширина + высота.

### 6.2 Когда для одной позиции в корзине находится несколько товаров в БД

Возможные случаи:

| Сценарий | Причина | Поведение в Excel |
|----------|---------|-------------------|
| **Разные поставщики** | Одна и та же конфигурация (модель, размер, покрытие, цвет) заведена у нескольких поставщиков — в БД несколько Product с разными «Поставщик», ценами и т.д. | Одна логическая строка заказа: колонки №, Наименование, Количество, Цена, Сумма — общие (объединённые ячейки). Колонки для фабрики (Цена опт, Поставщик, Материал/Покрытие, Размеры, Цвет, SKU и т.д.) выводятся **по одной строке на каждый найденный товар** — исполнитель видит все варианты и выбирает, у какого поставщика размещать заказ. |
| **Дубликаты в БД** | Один и тот же товар импортирован дважды (одинаковые модель, размер, покрытие, цвет, поставщик). | Аналогично: несколько строк с одинаковыми данными. При необходимости дубликаты стоит чистить в каталоге. |
| **Неполные данные в корзине** | В `cart_data` нет размеров или цвета (только model). | Критерии поиска ослаблены, может совпасть много товаров. Выводятся **все найденные варианты** (без лимита). |

Во всех этих случаях в файле заказа: **одна позиция корзины = один блок**: общие №, Наименование, Количество, Цена, Сумма (при нескольких вариантах — объединённые ячейки по вертикали), затем по одной строке на каждый вариант для колонок «для фабрики».

### 6.3 Где это реализовано в коде

- **Поиск вариантов:** `lib/catalog/product-match.ts` — `getMatchingProducts(item)`. Для дверей отбор по коду модели, покрытию, цвету, ширине, высоте (строгое совпадение с БД); возвращается **массив всех подходящих Product** (без лимита), чтобы исполнитель мог выбрать поставщика. В Excel колонка «Название модели» заполняется из `props['Название модели']` найденного товара.
- **Вывод в Excel:** тот же файл, `generateExcelOrder()`:
  - при `matchingProducts.length === 0` — одна строка, колонки для фабрики из корзины (fallback);
  - при `matchingProducts.length >= 1` — одна строка по количеству и сумме, колонки для фабрики заполняются в цикле по `matchingProducts`; при `matchingProducts.length > 1` для колонок 1–5 вызывается `worksheet.mergeCells(...)` по вертикали.

### 6.4 Рекомендации

- Чтобы в файле заказа не появлялись лишние варианты из дубликатов — в каталоге обеспечить уникальность товара по смыслу (например, модель + размер + покрытие + цвет + поставщик).
- Если для одной конфигурации действительно несколько поставщиков — текущее поведение корректно: все варианты выводятся, выбор поставщика остаётся за фабрикой/менеджером.
- В корзине и в `cart_data` при создании заказа всегда сохранять полную конфигурацию (model, finish, color, width, height), чтобы поиск был точным и предсказуемым.
