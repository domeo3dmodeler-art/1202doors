# Что мы сделали для защиты и от трафика — и что это решает

Кратко: что реально внедрено, от чего это защищает и от чего — нет.

---

## 0. Деплой артефактом (рекомендуемый способ)

**Что сделано:** Скрипт **`deploy-standalone-to-vm.ps1`** (запуск: `npm run deploy:standalone`). Сборка выполняется **только на вашем ПК**; на ВМ загружается готовый архив (standalone Next.js). На ВМ **не выполняется** `npm install` / `npm ci` — только распаковка и перезапуск systemd-сервиса.

**Что это решает:**
- **SSH не «ломается»** из-за перегрузки ВМ во время установки сотен пакетов и выполнения их скриптов.
- **Нет всплеска трафика** с ВМ в сторону npm registry при каждом деплое (десятки/сотни МБ, иногда сбойные повторные запросы).
- **Нет выполнения кода из зависимостей** на ВМ — скрипты postinstall и т.п. не запускаются на сервере.

Подробно: [DEPLOY_STANDALONE_ARTIFACT.md](./DEPLOY_STANDALONE_ARTIFACT.md).

---

## 1. Защита от вредоносного кода при установке пакетов (npm)

**Что сделано:**
- На ВМ при деплое зависимости ставятся так: **`npm ci --ignore-scripts`**, затем вручную **`npx prisma generate`** (в скриптах деплоя и в инструкции по новой ВМ).
- В пре-деплой добавлен шаг **`npm audit`** (предупреждение при известных уязвимостях).
- В репозитории есть **`package-lock.json`**, используется **`npm ci`** — установка детерминирована.

**Что это решает:**
- Снижается риск, что при установке библиотек выполнится чужой код (postinstall/preinstall из зависимостей). Это защита **цепочки поставок**, а не от сканирования извне.

**Что это не решает:**
- Не блокирует сканирование портов и запросы к приложению с интернета.
- Не уменьшает трафик от ботов, которые ходят на ваш открытый порт 3000.

---

## 2. Сохранение доступа по SSH (ключ не пропадает)

**Что сделано:**
- Описано и рекомендовано при создании новой ВМ **добавлять ваш SSH-ключ в метаданные ВМ** в Yandex Cloud (блок «Доступ»). Тогда cloud-init при первом запуске и при применении метаданных записывает ключ в `~/.ssh/authorized_keys` и не затирает его при перезагрузке.
- Описано восстановление ключа вручную через консоль ВМ, если доступ уже потерян, и повторное добавление ключа в метаданные.

**Что это решает:**
- SSH-доступ перестаёт «пропадать» после перезагрузки или обновления метаданных ВМ из-за перезаписи `authorized_keys`.

**Что это не решает:**
- Не защищает от перебора паролей по SSH (для этого нужны, например, отключение входа по паролю, fail2ban или ограничение доступа по IP для порта 22).
- Не связано с трафиком и сканированием приложения.

---

## 3. Трафик и «несанкционированный доступ» к приложению

**Что сделано:**
- Рекомендация **отключить автообновления ОС** на ВМ (`unattended-upgrades`) — уменьшает фоновый исходящий трафик на обновления пакетов.
- Описана проверка нагрузки (логи, `ss`, `journalctl`) чтобы понимать, кто обращается к сервису.
- Ограничивать доступ к приложению (порт 3000) только своим IP мы **не стали** — вы передаёте проект на тестирование, тестировщикам нужен доступ с любых IP. Поэтому порт 3000 в инструкциях открыт для всех (0.0.0.0/0).

**Что это решает:**
- Небольшое снижение трафика за счёт отключения автообновлений.
- Понимание, откуда идёт нагрузка (логи, мониторинг).

**Что это не решает:**
- **Сканирование:** порт 3000 остаётся открыт в интернет. Сканеры и боты по-прежнему могут обнаруживать сервис и слать запросы — мы ничего не ставили для блокировки сканирования (WAF, rate limiting на уровне сети, fail2ban для HTTP и т.д.).
- **«Несанкционированный доступ» к приложению:** доступ к сайту не ограничен по IP; авторизация — только средствами самого приложения (логин/пароль, роли). Дополнительной сетевой защиты (например, VPN только для тестировщиков) мы не добавляли.
- **Скачивание трафика:** часть трафика по-прежнему будет от ботов и сканеров, обращающихся к вашему публичному URL. Это не «утечка» в смысле вредоносного кода — просто факт публично доступного сервиса.

---

## Сводка: решаются ли ваши проблемы?

| Проблема | Что мы сделали | Решает ли? |
|----------|----------------|------------|
| SSH перестаёт работать после деплоя / перегрузка при npm на ВМ | **Деплой артефактом** (`npm run deploy:standalone`) — npm на ВМ не запускается | **Да** — сборка на ПК, на ВМ только распаковка и перезапуск. |
| SSH пропадает после перезагрузки ВМ (ключ затирается) | Ключ в метаданных ВМ, инструкция по восстановлению | **Да** — если ключ добавлен в метаданные и при необходимости восстановлен по инструкции. |
| Вредоносный код при установке библиотек на ВМ | Деплой артефактом (нет npm на ВМ); при деплое через git — `npm ci --ignore-scripts` + ручной `prisma generate`, npm audit | **Да** — при артефакте на ВМ ничего не ставится; при git-деплое скрипты пакетов не выполняются. |
| Большой расход трафика «без использования» | Отключение unattended-upgrades; порт 3000 оставлен открытым для тестировщиков | **Частично** — меньше фонового трафика от ОС; трафик от ботов на приложение **не** ограничен (специально, чтобы тестировщики могли заходить). |
| Сканирование и несанкционированный доступ к приложению | Явных мер не вводили (ни WAF, ни ограничение по IP для 3000, ни rate limiting) | **Нет** — сканирование и запросы с любых IP к порту 3000 по-прежнему возможны; доступ контролируется только логином/ролями в приложении. |

---

## Если нужно усилить защиту от сканирования и трафика

Без ограничения доступа тестировщиков можно добавить позже, при необходимости:

- **Rate limiting** на уровне приложения (например, ограничение числа запросов с одного IP в минуту) — часть ботов отсечётся, трафик уменьшится.
- **Nginx перед приложением** с лимитами и при необходимости базовой фильтрацией по User-Agent или по путям.
- **Fail2ban** для HTTP — блокировка IP после множества подозрительных запросов (например, к типичным путям сканеров).
- **WAF** (в т.ч. облачный) — фильтрация по известным атакам и шаблонам.

Текущие меры **решают в первую очередь**: стабильный SSH, безопасную установку пакетов и небольшое снижение фонового трафика. Проблему «сканирование и лишний трафик от всех подряд» при открытом доступе для тестировщиков они **не решают** — для этого нужны дополнительные меры выше.
