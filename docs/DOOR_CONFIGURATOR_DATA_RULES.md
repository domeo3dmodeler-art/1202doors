# Правила данных конфигуратора дверей

Единая схема без костылей: один источник правды на каждом уровне.

---

## 1. Источники данных (БД)

### Product (товар)
- **Код модели Domeo (Web)** — идентификатор модели. Один код может быть у товаров разных стилей.
- **Domeo_Стиль Web** — стиль (Классика, Неоклассика и т.д.).
- **Тип покрытия** — ПВХ, ПЭТ, Эмаль, Шпон.
- **Цвет/Отделка** — название цвета.
- **Название модели** — фабричное название (для отображения, не для связей).

**Правило:** Покрытия и цвета для пары (модель, стиль) определяются **только** товарами с этим кодом и этим стилем. Нет «подмешивания» товаров других стилей.

### PropertyPhoto (фото)
- **propertyName** `"Код модели Domeo (Web)"` — обложка модели. **propertyValue** = код в нижнем регистре (например `domeodoors_pearl_6`).
- **propertyName** `"Domeo_Модель_Цвет"` — фото по цвету. **propertyValue** = `"Код|Тип покрытия|Цвет"` (например `DomeoDoors_Base_1|ПВХ|Белый`). Сравнение в API через trim + toLowerCase.

**Правило:** Пути к картинкам берутся **только** из PropertyPhoto. Нет fallback по «Название модели», нет угадывания по имени файла (кроме одного явного правила ниже).

---

## 2. API complete-data

**Маршрут:** `GET /api/catalog/doors/complete-data`

### Кто попадает в ответ
- Одна запись на пару **(modelKey, style)**, для которой есть **хотя бы один товар** (Product с этим кодом и стилем).
- Записей с пустым списком товаров **нет** — такие пары не отдаём.

### Покрытия и цвета (coatings, finishes, colorsByFinish)
- Строятся **только** из товаров этой пары (modelKey + style).
- У каждого товара берём (Тип покрытия, Цвет/Отделка), собираем уникальные пары в `coatings`.
- **Фото цвета** (photo_path у каждого coating): один запрос в PropertyPhoto — `Domeo_Модель_Цвет` с value = `modelKey|Тип покрытия|Цвет` (нормализация: trim + toLowerCase). Если записи нет — `photo_path = null`.

### Обложка модели (photo, photos.cover)
Порядок (без ветвлений по «Название модели» и т.п.):

1. **PropertyPhoto** по коду: `propertyName = "Код модели Domeo (Web)"`, `propertyValue = modelKey.toLowerCase()`. Тип `cover`. Если есть — берём этот путь.
2. **PropertyPhoto** по цветам: `propertyName = "Domeo_Модель_Цвет"`, поиск по префиксу `modelKey + "|"` (нормализованный код). Первое фото с типом `cover`. Если нашли — используем его.
3. Если у модели уже есть coatings с заполненным photo_path — берём **первое** такое photo_path как обложку.
4. Иначе — **null** (на UI показываем плейсхолдер).

ProductImage по товарам не используем (источник правды для путей — PropertyPhoto).

---

## 3. Фронт

- **useConfiguratorData:** один запрос `complete-data`, сохраняем `rawModels` и маппим в `models` (id, photo, sizes, doorOptions и т.д.).
- **useModelDetails(modelId, rawModels, selectedStyle):** выбор из `rawModels` записи с `modelKey === modelId` и `style === selectedStyle`. Оттуда берём coatings, finishes, colorsByFinish, options. Доп. запрос complete-data только если в rawModels нет подходящей записи.
- **useModelOptions:** каскадная фильтрация (реверс, наполнение, размер, покрытие, цвет) — какие опции остаются доступны. Не подменяет список покрытий/цветов; список приходит из complete-data.

**Правило:** Сетка моделей и вкладка «ПОКРЫТИЕ И ЦВЕТ» питаются одними и теми же данными из complete-data. Если в ответе есть запись (modelKey, style), у неё уже есть непустые coatings (или явно пустой массив только когда по товарам действительно нет ни одного покрытия — но такие записи мы не отдаём).

---

## 4. Итог

| Что | Источник | Правило |
|-----|----------|--------|
| Список пар (модель, стиль) | Product | Только пары с ≥1 товаром |
| Покрытия и цвета | Product (Тип покрытия, Цвет/Отделка) | Только товары этой пары (modelKey, style) |
| Путь к фото цвета | PropertyPhoto `Domeo_Модель_Цвет` | Один кандидат: `modelKey\|Тип покрытия\|Цвет` |
| Обложка модели | PropertyPhoto | Сначала по коду, потом по префиксу кода в цветах, потом первое из coatings, иначе null |

Никаких allProductsForModel, подстановок по «Название модели» для связей, Артикул поставщика, вариантов _1…_10 — всё решается через Product и PropertyPhoto по этим правилам.
