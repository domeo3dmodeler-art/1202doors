# Защита от сканеров и ботов (без смены порта)

Решения, которые **определяют** подозрительный трафик (сканеры, боты) и **ограничивают или блокируют** его, чтобы не пускать их к приложению.

---

## Решения в Yandex Cloud (нативно)

### Smart Web Security (SWS)

Сервис Yandex Cloud для защиты веб-приложений от DDoS L7 и ботов.

- **Web Application Firewall (WAF)** — блокирует по сигнатурам (SQL-инъекции, XSS, OWASP Top 10 и т.д.), в т.ч. типичное поведение сканеров.
- **Антиробот** — поведенческий анализ и ML, отсекает ботов и часть автоматизированного трафика.
- **SmartCaptcha** — при срабатывании правил можно отправлять подозрительных на проверку (капча), а не сразу резать.
- **Rate Limiter** — ограничение частоты запросов по правилам (по IP, по пути и т.д.).

**Как подключается:** трафик идёт не напрямую на ВМ, а через **Application Load Balancer (ALB)**. К бэкенд-группе ALB привязывается **профиль Smart Web Security**; ALB принимает запросы → SWS фильтрует → на ВМ уходит уже отфильтрованный трафик.

**Ограничения:** нужна схема «пользователь → ALB (с SWS) → ваша ВМ». То есть приложение должно открываться через балансировщик (как правило по домену и часто на 80/443), а не «напрямую по IP:3000». Для доступа по `http://IP:3000` без домена и ALB SWS в текущем виде не подставишь.

**Доступ:** на момент 2024–2025 сервис в Public Preview, бесплатно по запросу для ограниченного числа пользователей. Подключение и квоты — через консоль Yandex Cloud или поддержку.

**Документация:** [Smart Web Security](https://cloud.yandex.ru/docs/smartwebsecurity/), [ALB с профилем SWS](https://cloud.yandex.ru/docs/tutorials/security/alb-ingress-with-sws-profile).

### DDoS Protection (L3/L4)

Защита от объёмных DDoS на сетевом уровне (L3/L4) в Yandex Cloud обычно входит в базовую защиту инфраструктуры; при больших атаках могут подключать усиленную защиту. От сканеров и ботов на уровне HTTP (L7) она не помогает — для этого как раз Smart Web Security / WAF.

### Группы безопасности (Firewall)

Не «определяют» сканеров, но **жёстко режут трафик**: можно закрыть порт 3000 для всего мира и открыть только для ваших IP. Тогда сканеры до ВМ вообще не доходят. Настройка в консоли: VPC → Группы безопасности → правила входящего трафика.

---

## Решения на ВМ (не только Yandex)

## 1. Fail2ban (на ВМ)

**Что делает:** читает логи (nginx, приложения или системные), при повторяющихся подозрительных запросах с одного IP добавляет правило в firewall (iptables) и **временно блокирует** этот IP (например на 10 минут или час).

**Плюсы:** бесплатно, ставится на вашу ВМ, гибкие правила (пути, коды ответа, частота).  
**Минусы:** нужен веб-сервер или логи в стандартном формате; настройка правил под ваше приложение.

**Идея:** фильтр по путям типичных сканеров (`/.env`, `/wp-admin`, `/api/health` с огромной частотой, запросы без нормального User-Agent и т.д.) → бан IP.

**Установка (на ВМ):**  
`sudo apt install fail2ban`  
Дальше — jail для HTTP (логи nginx или приложения) и фильтры под ваши эндпоинты.

---

## 2. Nginx перед приложением (reverse proxy + лимиты)

**Что делает:** весь трафик идёт на Nginx (порты 80/443), Nginx проксирует на `localhost:3000`. На уровне Nginx можно:
- **limit_req_zone** — ограничить число запросов с одного IP в секунду (rate limit);
- блокировать запросы с пустым или типичным для ботов **User-Agent**;
- возвращать 444 или 403 для подозрительных **путей** (например известные пути сканеров).

**Плюсы:** один раз настроил — режете трафик до входа в Node.js, меньше нагрузки на приложение.  
**Минусы:** нужно поднять и настроить Nginx на ВМ.

Сканеры часто ходят без нормального User-Agent или с типичными строками (scanner, bot, curl и т.д.) — по ним можно резать или ограничивать.

---

## 3. WAF (Web Application Firewall)

**Что делает:** анализирует HTTP-запросы по правилам (сигнатуры атак, ботов, сканеров) и блокирует подозрительные до того, как они дойдут до приложения.

**Варианты:**
- **Облачный WAF:** Cloudflare (перед сайтом ставится их прокси — они фильтруют трафик), аналоги у других провайдеров. Часто совмещён с DDoS-защитой и бот-детекцией.
- **На сервере:** ModSecurity (модуль для Nginx/Apache) + набор правил (например OWASP Core Rule Set). Работает на вашей ВМ за Nginx.

**Плюсы:** именно «определяют и не пускают» по сигнатурам.  
**Минусы:** облачный — нужен домен и настройка DNS; ModSecurity — сложнее настройка и поддержка правил.

---

## 4. Cloudflare (или аналог) перед сайтом

**Что делает:** вы поднимаете домен и указываете A-запись на IP ВМ; трафик к сайту идёт сначала на Cloudflare. Они:
- фильтруют известных ботов и сканеров;
- могут показывать **challenge** (капча/проверка браузера) подозрительным посетителям;
- есть режим «Under Attack» — усиленная проверка перед доступом к сайту.

**Плюсы:** не нужно ничего ставить на ВМ, сразу меньше «мусорного» трафика.  
**Минусы:** нужен домен и смена DNS; для доступа по одному IP без домена не подойдёт (можно использовать только если будете открывать приложение по имени).

---

## 5. Rate limiting в приложении (уже есть частично)

**Что сделано:** в проекте уже включён лимит запросов для `/api/health` и GET `/api/catalog/doors/complete-data` (например 60 запросов в минуту с одного IP). Превышение → 429, сканер не получает тяжёлый ответ.

**Идея:** расширить лимиты на другие публичные тяжёлые эндпоинты или на все публичные API по умолчанию. Сканеры не «пускаются» в смысле ограничения частоты — они получают отказ и не могут выкачивать гигабайты.

---

## 6. Ограничение по IP в группе безопасности (Yandex Cloud)

**Что делает:** не «определяет» сканеров, а **вообще не пускает** на порт приложения никого, кроме ваших IP (и при необходимости IP тестировщиков). Сканеры с других адресов до ВМ не доходят.

**Плюсы:** максимально просто и надёжно, трафик падает сразу.  
**Минусы:** тестировщикам с динамических IP нужен либо список их IP, либо VPN с фиксированным IP.

---

## Сводка

| Решение | Определяет сканеров? | Где ставится | Сложность |
|--------|----------------------|--------------|-----------|
| Fail2ban | По правилам (пути, частота) | ВМ | Средняя |
| Nginx + limit_req + User-Agent | По частоте и заголовкам | ВМ | Средняя |
| WAF (ModSecurity) | По сигнатурам | ВМ за Nginx | Выше |
| Cloudflare | Да, у провайдера | Перед сайтом (DNS) | Низкая (если есть домен) |
| Rate limit в приложении | Ограничивает по частоте | Уже в коде | Низкая |
| Группа безопасности (только ваш IP) | Нет, пускает только вас | Yandex Cloud | Низкая |

Да, решения по безопасности, которые **определяют сканеров и не пускают** их (или сильно ограничивают), есть: Fail2ban, Nginx с лимитами и фильтрами по User-Agent/путям, WAF (облачный или ModSecurity), Cloudflare. Выбор зависит от того, есть ли у вас домен, готовы ли ставить Nginx на ВМ и насколько жёстко хотите резать трафик (только сканеры — Fail2ban/Nginx, или «только свои IP» — группа безопасности).
