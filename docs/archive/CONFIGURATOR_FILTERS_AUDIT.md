# Аудит логики и фильтров калькулятора дверей

Дата: 2026-02-12

## 1. Источники данных

| Источник | Что отдаёт | Когда вызывается |
|----------|------------|-------------------|
| **complete-data** | Все модели (modelKey, style, photo, sizes, doorOptions, **filling_names**), по каждой модели: coatings, colorsByFinish, edge_options, glassColors, products | Один раз при загрузке страницы (useConfiguratorData), кэш 30 мин |
| **useModelDetails(id, rawModels)** | Детали одной модели: coatings, finishes, colorsByFinish, edges, options. Если передан rawModels — без повторного запроса | При выборе модели; при смене rawModels |
| **model-options** (GET) | Каскадные опции по отфильтрованным товарам: fillings, widths, heights, finishes, colorsByFinish, edges, revers_available, mirror_available, threshold_available | При выборе модели + при изменении reversible, **filling**, width, height, finish, color |
| **price/doors** (POST) | Цена по selection (model, style, finish, color, width, height, edge_id, …) | При canCalculatePrice (модель, размеры, покрытие и цвет выбраны) |

---

## 2. Цепочка фильтров на странице

### 2.1 Список моделей (карточки)

- **Вход:** `allModels` (из complete-data), `selectedStyle`, `selectedFilling`.
- **Фильтр:**
  1. По стилю: `m.style === selectedStyle`.
  2. По наполнению: `m.filling_names.includes(selectedFilling)` (или fallback `[m.doorOptions.filling_name]`).
- **Результат:** `filteredModels` — модели для отображения в сетке.

Важно: для фильтра по наполнению в объект модели из useConfiguratorData должен передаваться массив **filling_names** (исправлено ранее).

### 2.2 Каскад опций (model-options API)

Порядок фильтрации товаров в API:

1. Модель + стиль (Код модели Domeo (Web), Domeo_Стиль Web).
2. Реверс (если reversible=true).
3. **Наполнение** (Domeo_Опции_Название_наполнения === filling).
4. Ширина (Ширина/мм).
5. **Высота (Высота/мм)** — см. критичную проблему ниже.
6. Тип покрытия (Тип покрытия).
7. Цвет (Domeo_Цвет).

По отфильтрованному набору товаров собираются: fillings, widths, heights, finishes, colorsByFinish, edges, revers_available, mirror_available, threshold_available.

### 2.3 Что показывается в UI

- **Ширина/высота:** из `selectedModelData.sizes` (complete-data), т.е. по **всем** товарам модели, без учёта выбранного наполнения и без учёта каскада model-options. Плюс к высотам добавлены диапазоны 2301–2500 и 2501–3000.
- **Типы покрытия:** при выбранной модели и непустом `modelOptionsData.finishes` — из каскада, иначе из useModelDetails (finishes).
- **Цвета по покрытию:** при выбранной модели и непустом `modelOptionsData.colorsByFinish[selectedFinish]` — только разрешённые каскадом, иначе все цвета выбранного типа из модели.
- **Кромка:** при непустом `modelOptionsData.edges` — только разрешённые каскадом, иначе все edges модели.
- **Реверс:** отображается, но при `!modelOptionsData.revers_available` переключатель «Да» недоступен и значение сбрасывается.

---

## 3. Критичные проблемы

### 3.1 Расчёт цены не учитывает наполнение

- В **price/doors** при подборе товара по selection **нет** фильтра по `Domeo_Опции_Название_наполнения`.
- Учитываются: model, style, finish, color, width, height (для высот 2350/2750 подставляется 2000).
- **Следствие:** при выборе «Голд» цена может посчитаться по товару с наполнением «Сильвер», если по модели есть несколько товаров с одинаковыми размером/покрытием/цветом, но разным наполнением.
- **Рекомендация:** добавить в selection поле `filling` и в price/doors фильтровать товары по `Domeo_Опции_Название_наполнения === selection.filling` (при наличии filling).

### 3.2 Высота 2301–2500 / 2501–3000 в model-options

- В UI высоты-диапазоны передаются как **2350** и **2750**.
- В **model-options** фильтр по высоте: `Высота/мм == heightParam`. В БД у товаров высоты 2000, 2100, … — значений 2350/2750 нет.
- **Следствие:** при выборе «2301–2500» или «2501–3000» в model-options уходит height=2350 или 2750, отфильтрованный набор товаров пустой, API возвращает пустые fillings, widths, heights, finishes, colorsByFinish. Для размеров и типов покрытия UI использует fallback (sizes из complete-data, finishes из useModelDetails), но каскад по наполнению/размеру/покрытию/цвету для этих высот не работает.
- **Рекомендация:** в model-options при heightParam 2350 или 2750 подставлять для фильтрации товаров высоту **2000** (базовая), а в ответ по heights по-прежнему возвращать фактические высоты из товаров плюс при необходимости явные метки диапазонов.

### 3.3 Выбранная модель может «выпасть» из списка

- При сужении фильтров (например, смена «Все» → «Голд») `filteredModels` уменьшается.
- Если текущий `selectedModelId` не входит в новый `filteredModels`, он **не сбрасывается**: в сетке эта модель уже не показывается, но в состоянии и в спецификации она остаётся выбранной.
- **Рекомендация:** при изменении filteredModels проверять `filteredModels.some(m => m.id === selectedModelId)`; если нет — сбрасывать selectedModelId (например, в null или в первую модель из filteredModels).

### 3.4 Дефолтный стиль «Современные»

- В коде: `useState<string>('Современные')`.
- Если в данных нет стиля с именем «Современные» (опечатка, другое название), то `filteredModels` после фильтра по стилю будет пустым, пользователь не видит моделей.
- **Рекомендация:** при первой загрузке выставлять selectedStyle в первый элемент из `availableStyles` (например, в useEffect при появлении availableStyles), либо проверять `availableStyles.includes(selectedStyle)` и при несовпадении подставлять availableStyles[0].

---

## 4. Прочие замечания

### 4.1 Два смысла «наполнение»

- **selectedFilling** — фильтр по списку моделей и параметр каскада (название из листа «Опции»: Голд, Сильвер и т.д.).
- **filling** (state: standard/good/excellent) — не используется в фильтрах и в API; осталось от удалённого блока «Стандартное/Хорошее/Отличное»; в спецификации показывается через getFillingText(). Имеет смысл либо убрать, либо явно документировать как только информационное.

### 4.2 Порядок применения фильтров в model-options

- Сейчас: reversible → filling → width → height → finish → color. Логично: сначала модель/стиль, затем опции (реверс, наполнение), затем размер, затем покрытие и цвет. Порядок согласован с UI (сначала размеры и наполнение, потом покрытие и цвет).

### 4.3 Кромка и modelOptionsData.edges

- Если у товаров в БД не заполнено свойство «Кромка», а опции кромки заданы через complete-data (edge_options), то modelOptionsData.edges может быть пустым, и тогда в UI показываются все edge_options модели — поведение приемлемое (fallback).

### 4.4 Спецификация и цена

- В спецификации выводится «Наполнение: Голд» (selectedFilling) и отдельно getFillingText() (standard/good/excellent). Для однозначности лучше в блоке спецификации явно показывать выбранное наполнение из фильтра (selectedFilling), а не только «звукоизоляционное» описание.

---

## 5. Краткая сводка

| № | Проблема | Критичность | Где править |
|---|----------|-------------|-------------|
| 1 | Цена не учитывает наполнение (filling) | Высокая | price/doors (POST), useConfiguratorData (передать filling в calculatePrice) |
| 2 | При высотах 2350/2750 model-options возвращает пустой каскад | Высокая | model-options: при height 2350/2750 фильтровать по height 2000 |
| 3 | selectedModelId не сбрасывается при сужении фильтров | Средняя | doors/page.tsx: эффект при смене filteredModels |
| 4 | Дефолтный стиль «Современные» может отсутствовать в данных | Средняя | doors/page.tsx: инициализация selectedStyle от availableStyles |
| 5 | Два разных «наполнения» (фильтр vs standard/good/excellent) | Низкая | Документация или упрощение UI |

---

## 6. Рекомендуемый порядок исправлений

1. **price/doors** — добавить учёт наполнения в подбор товара и (при необходимости) в selection.
2. **model-options** — нормализовать height 2350/2750 в 2000 при фильтрации товаров.
3. **doors/page.tsx** — сброс selectedModelId, когда модель не входит в filteredModels.
4. **doors/page.tsx** — инициализация/коррекция selectedStyle по availableStyles.

После этого имеет смысл повторно прогнать сценарии: «Стиль + Наполнение Голд», «Высота 2301–2500», смена «Все» → «Голд» при уже выбранной модели и проверить цену и список опций.
