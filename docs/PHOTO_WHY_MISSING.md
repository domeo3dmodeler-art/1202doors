# Почему у части дверей нет фото — итог диагностики

Диагностика: **GET /api/debug/photo-paths** (запусти приложение и открой в браузере).

---

## Как fallback собирает путь к файлу

**Где:** `app/api/catalog/doors/complete-data/route.ts`, функция `fallbackLocalPathForColor`.

**Вход:** строка вида `"Название модели|Тип покрытия|Цвет/отделка"`.

**Откуда берутся части:**
- **Название модели** — первое из `factoryModelNames` (поле товара «Название модели» или «Domeo_Название модели для Web»), например: `Дверное полотно A-Line 1 ПО кр.`
- **Тип покрытия** — из товара `Тип покрытия`, например: `ПО кр.` или `ПО Алюминий`
- **Цвет/отделка** — из товара `Цвет/Отделка`, например: `Черный (RAL 9005)`

**Преобразование (slug):** для каждой из трёх частей:
- пробелы → `_`
- слэш `/` → `_` (например `10/2` → `10_2`)
- удаляются символы, кроме букв (в т.ч. кириллица), цифр, `-`, `_`, `.`, `(`, `)`
- длина ограничена: модель 60 символов, покрытие 30, цвет 40

**Итоговое имя файла:**  
`{modelPart}_{coatingPart}_{colorPart}_cover.png`

**Полный путь:**  
`/uploads/final-filled/doors/{modelPart}_{coatingPart}_{colorPart}_cover.png`  
(папка задаётся в `lib/configurator/photo-paths.ts` — `DOOR_PHOTOS_SUBFOLDER`).

**Пример:**  
Вход: `Дверное полотно A-Line 1 ПО кр.|ПО Алюминий|Черный (RAL 9005)`  
→ slug: `Дверное_полотно_A-Line_1_ПО_кр._` + `ПО_Алюминий` + `Черный_(RAL_9005)`  
→ файл: `Дверное_полотно_A-Line_1_ПО_кр._ПО_Алюминий_Черный_(RAL_9005)_cover.png`  
→ путь: `/uploads/final-filled/doors/Дверное_полотно_A-Line_1_ПО_кр._ПО_Алюминий_Черный_(RAL_9005)_cover.png`

Если на диске файл назван иначе (например без «Дверное_полотно_», или «ПО кр.» вместо «ПО Алюминий»), точного совпадения не будет — тогда срабатывает только fallback в **GET /api/uploads/[...path]**: подстановка варианта с префиксом «Дверное_полотно_» и поиск по префиксу модели.

## Что видно по данным

### 1. Пути в БД указывают на старую папку «Цвет»

В таблице **PropertyPhoto** для обложек по коду модели (Pearl_6, Pearl_7, Invisible и т.д.) в `photoPath` записано:
- `/uploads/final-filled/Цвет/Имя_файла.png`

Папку переименовали в **doors**, поэтому по такому пути файла нет.  
В коде уже есть подстановка: при запросе файла и при формировании URL путь **Цвет** заменяется на **doors**. После замены файлы **находятся** (в диагностике `existsWithDoors: true` для этих записей).

**Вывод:** для моделей, у которых в БД локальный путь вида `.../Цвет/...`, фото должны открываться за счёт этой подстановки. Если у тебя такие модели всё равно без фото — стоит проверить один конкретный запрос в Network (какой URL у картинки и какой ответ у него).

---

### 2. В листе «Цвет» (Domeo_Модель_Цвет) много записей с внешней ссылкой

Для многих комбинаций «модель | тип покрытия | цвет» в **PropertyPhoto** в поле `photoPath` лежит не локальный путь, а **внешний URL** (например `https://disk.360.yandex.ru/...`).

В **complete-data** такие пути специально отбрасываются:

- в `normalizePhotoPath` для путей, начинающихся с `http://` или `https://`, возвращается **null**;
- в интерфейсе используются только пути из `public/uploads/` (в т.ч. `final-filled/doors`).

Поэтому для таких записей «Цвет» фото из БД **вообще не используется** — обложка не подставляется из PropertyPhoto.

Откуда тогда может взяться картинка:

- из **обложки по коду модели** (PropertyPhoto по коду модели с локальным путём), если она есть;
- из **fallback** в complete-data: путь собирается по шаблону  
  `final-filled/doors/{модель}_{покрытие}_{цвет}_cover.png`;  
  если такого файла нет, раздача в **GET /api/uploads/[...path]** пытается подставить вариант с префиксом «Дверное_полотно_» и подбор по префиксу модели.

Если в папке **doors** для этой модели/покрытия/цвета файла нет и подходящего по префиксу тоже нет — фото в интерфейсе не будет.

**Вывод:** основная причина «нет фото» у части дверей — в БД для них в листе «Цвет» стоят **только внешние URL**, они не используются, а локального файла в `final-filled/doors` по сформированному имени нет (или имя строится иначе, чем файлы на диске).

---

## Что можно сделать

1. **Проверить один запрос в браузере**  
   Открыть страницу дверей, во вкладке Network найти запрос к картинке (фильтр Img или по пути `/api/uploads/`). Посмотреть:
   - какой URL запрашивается;
   - ответ: 200 (файл найден) или 404 (файл не найден).

2. **Привести пути в БД к локальным**  
   Для записей в PropertyPhoto (лист «Цвет»), где сейчас `https://...`, при наличии файлов в `public/uploads/final-filled/doors/` можно обновить `photoPath` на локальный путь (например через скрипт/импорт), чтобы эти фото начали использоваться.

3. **Проверить имена файлов в doors**  
   Имена должны соответствовать тому, как их собирает fallback (модель_покрытие_цвет_cover.png) или раздача должна находить их по префиксу модели. При необходимости поправить либо имена файлов, либо логику формирования пути в complete-data.

---

## Кратко

| Причина | Что происходит | Результат |
|--------|----------------|-----------|
| В БД путь с папкой **Цвет** | Папка переименована в **doors** | В коде делается подстановка Цвет→doors, файл ищется в `doors` |
| В БД для «Цвет» записан **https://...** | complete-data отбрасывает внешние URL | Для этой комбинации модель/покрытие/цвет фото из БД не используется |
| Нет подходящего файла в **doors** | Fallback строит путь, раздача не находит файл (в т.ч. по префиксу) | В интерфейсе нет фото |

Диагностический маршрут **/api/debug/photo-paths** можно удалить или отключить после отладки.
