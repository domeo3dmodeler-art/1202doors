# Стек и проблема (Domeo Doors, staging на ВМ)

## Стек

| Слой | Технология |
|------|------------|
| **Приложение** | Next.js (React), TypeScript, Prisma |
| **БД** | PostgreSQL |
| **Хостинг** | Одна ВМ в Yandex Cloud (Ubuntu), IP 84.201.160.50 |
| **Деплой** | Код в `~/1002doors` на ВМ, сборка на ВМ (`npm run build`), сервис systemd `domeo-staging` (Next.js на порту 3000) |
| **Доступ** | SSH: ключ `ssh-key-1771392782781` (путь на ПК: `C:\Users\petr2\.ssh\ssh-key-1771392782781\`), пользователь `ubuntu` |
| **Прокси/защита** | Nginx (reverse proxy на 80 → 3000), Fail2ban — при применении скриптов из репозитория |
| **Экспорт** | PDF: Puppeteer + Chromium/Chrome; Excel/CSV: свой генератор (ExcelJS и т.п.) |
| **Файлы/фото** | Опционально Yandex Object Storage (S3-совместимый API) |
| **Метаданные ВМ** | SSH-ключ и cloud-init `user-data` задаются в консоли Yandex Cloud; `user-data` с `#cloud-config` создаётся платформой при добавлении ключа, не вручную |

Приложение: конфигуратор дверей, заказы, КП, счета, экспорт в PDF/Excel, каталог, роли (админ, комплектатор, исполнитель). Rate limiting и CORS настроены в коде.

---

## Проблема (кратко)

1. **Огромный трафик на ВМ (~100 ГБ/час)**  
   Сканеры/боты/DDoS бьют по открытому порту (80 или 3000). Трафик съедает квоту и создаёт нагрузку.

2. **При таком трафике перестаёт работать SSH по ключу**  
   Возможные причины:
   - **Fail2ban** банит ваш IP вместе с атакующими (лимиты Nginx/SSH).
   - **Cloud-init** при перезагрузке или обновлении метаданных перезаписывает `~/.ssh/authorized_keys` из метаданных ВМ — если там нет вашего ключа, доступ пропадает.
   - **Взлом:** при RCE на ВМ злоумышленник может изменить `authorized_keys` (удалить ваш ключ, добавить свой), поменять конфиг SSH, cron и т.д.

3. **Экспорт в PDF на ВМ падал**  
   Puppeteer не мог запустить браузер: не было Chrome/Chromium; позже при установке через snap — ошибка «not a snap cgroup». Решение: ставить Google Chrome из .deb и не использовать snap.

4. **Расход трафика фоновыми процессами**  
   Автообновления (snap refresh, apt unattended-upgrades, apt-daily) качают обновления. Решение: скрипт `vm-reduce-traffic.sh` отключает их.

---

## Что сделано в репозитории

- **Защита от атак:** `scripts/vm-hardening-attack.sh` — жёсткие лимиты Nginx (3 req/s на IP), блок по User-Agent (сканеры), Fail2ban с длинным баном; поддержка `MY_IP`, чтобы не банить свой IP.
- **Документация:** `VM_TRAFFIC_ATTACK_PROTECTION.md` (группа безопасности, скрипт, проверка на взлом, почему ключ перестаёт работать), `VM_TRAFFIC_REDUCTION.md` (снижение фонового трафика), `EMERGENCY_TRAFFIC_AND_SSH.md`, `VM_SSH_AND_TRAFFIC_ISSUES.md`.
- **Рекомендации по группе безопасности:** порт 22 только с вашего IP, порт 80 — с интернета или только с вашего IP; остальное закрыть.
- **PDF на ВМ:** в коде приоритет у `/usr/bin/google-chrome-stable`; в `APPLY_SECURITY_ON_VM.md` — установка Chrome из .deb (скачать на ПК, скопировать на ВМ).
- **Метаданные ВМ:** в документации пояснено, что `user-data` с `#cloud-config` создаётся консолью Yandex Cloud при добавлении SSH-ключа, а не вручную.

Итог: стек — Next.js + PostgreSQL на одной ВМ в Yandex Cloud; проблема — большой трафик от сканеров/атак и из‑за этого потеря SSH по ключу (бан, перезапись ключей или взлом), плюс были сбои экспорта PDF и лишний трафик от автообновлений.
