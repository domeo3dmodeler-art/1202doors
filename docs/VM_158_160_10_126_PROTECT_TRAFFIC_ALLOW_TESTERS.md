# Защита от вредного трафика при доступе тестировщиков (ВМ 89.169.181.191)

Чтобы отдать ПО на тестирование, сайт должен быть доступен не только с вашего IP. Защита — не закрытие порта 80, а **лимиты и баны на ВМ**: тогда обычные пользователи работают, а сканеры и боты режутся.

---

## Схема

| Что | Как |
|-----|-----|
| **Порт 80** | Открыт для всех (0.0.0.0/0) — тестировщики заходят по ссылке. |
| **Порт 22** | Только ваш IP — SSH только у вас. |
| **Вредный трафик** | Режется на ВМ: Nginx (лимиты запросов, блок по User-Agent) + Fail2ban (бан на 24 ч при превышении). |
| **Обычный пользователь** | 3 запроса/с в среднем, до 10 в burst — хватает для браузера. Сканеры, делающие сотни запросов, упираются в лимит и получают бан. |

---

## Шаг 1. Группа безопасности

В Yandex Cloud → группа безопасности ВМ:

- **Входящие:**  
  - **80** — источник **0.0.0.0/0** (доступ для тестировщиков).  
  - **22** — источник **ваш_IP/32** (SSH только вы).
- Остальные входящие — удалить.
- Исходящие — без изменений (разрешено).

Так вы защищаетесь от вредного трафика не закрытием доступа, а лимитами на ВМ.

---

## Шаг 2. На ВМ: снижение фонового трафика и лимиты

Подключитесь по SSH и примените скрипты (или с ПК через `apply-vm-traffic-fix.ps1`).

**Ваш IP** добавьте в исключения Fail2ban (`MY_IP`), чтобы вас не забанило при активной работе:

```powershell
$env:1002DOORS_SSH_KEY = "C:\Users\petr2\.ssh\ssh-key-1771526730154\ssh-key-1771526730154"
$env:1002DOORS_STAGING_HOST = "ubuntu@89.169.181.191"
.\scripts\apply-vm-traffic-fix.ps1 -MyIp "185.149.245.13"
```

Что делают скрипты:

1. **vm-reduce-traffic.sh** — отключает автообновления snap и apt (меньше фонового исходящего трафика).
2. **vm-hardening-attack.sh** — настраивает Nginx и Fail2ban:
   - лимит запросов: в среднем 3 req/s (общие), 1 req/s для тяжёлых эндпоинтов (`/api/health`, `/api/catalog/doors/complete-data`);
   - лимит одновременных соединений с одного IP;
   - блок по User-Agent (nikto, sqlmap, пустой UA и т.п.);
   - Fail2ban: при превышении лимитов — бан на 24 часа.

Тестировщики с нормальным поведением (браузер, несколько запросов в секунду) не упираются в лимиты. Боты и сканеры — да, их трафик режется и они банятся.

---

## Шаг 3. Если тестировщики со статическим IP

Чтобы их точно не забанило, можно добавить их IP в Fail2ban. На ВМ:

```bash
sudo nano /etc/fail2ban/jail.d/domeo.conf
```

В строках `ignoreip = ...` допишите IP через пробел, например:

```
ignoreip = 127.0.0.1/8 ::1 185.149.245.13 95.xxx.xxx.xxx
```

Сохраните и перезапустите Fail2ban:

```bash
sudo systemctl restart fail2ban
```

Если статических IP нет — ничего делать не нужно, лимиты 3 req/s и burst 10 для обычного сценария достаточно.

---

## Итого

- **Защита от вредного трафика:** Nginx (лимиты + блок ботов по User-Agent) + Fail2ban на ВМ; порт 80 можно держать открытым для всех.
- **Отдать ПО на тестирование:** в группе безопасности открыть 80 с 0.0.0.0/0, 22 оставить только с вашего IP.
- **Ваш доступ:** при применении скриптов указать свой IP в `-MyIp`, чтобы не попасть под бан при нагрузочных проверках.

См. также: [VM_158_160_10_126_DEPLOY.md](./VM_158_160_10_126_DEPLOY.md), [VM_TRAFFIC_ATTACK_PROTECTION.md](./VM_TRAFFIC_ATTACK_PROTECTION.md).
