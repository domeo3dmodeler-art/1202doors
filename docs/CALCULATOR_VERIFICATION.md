# Полная проверка калькулятора дверей: фильтры, опции и расчёт цен

Документ описывает все фильтры, связи опций и правила расчёта, чтобы на 100% убедиться, что каждая опция считается правильно.

---

## 1. Источники данных

| Источник | Назначение |
|----------|------------|
| **GET /api/catalog/doors/complete-data** | Модели по стилю, покрытия/цвета по модели, кромки (каталог), реверс/зеркало/порог/наполнение по модели, фото |
| **GET /api/catalog/doors/model-options** | Каскадные опции по текущему выбору: модель + стиль + реверс + наполнение + размер + покрытие + цвет → списки и флаги |
| **POST /api/price/doors** | Расчёт цены по selection: подбор товара двери + надбавки за опции |

---

## 2. Порядок фильтров (model-options)

Цепочка в `app/api/catalog/doors/model-options/route.ts` и `lib/catalog/doors-model-options.ts`:

| Шаг | Параметр | Поле в БД | Примечание |
|-----|----------|-----------|------------|
| 1 | `model` + `style` | Код модели Domeo (Web), Domeo_Стиль Web | Обязательны |
| 2 | `reversible=true` | Domeo_Опции_Реверс_доступен содержит «да» | Если не передан — не фильтруем |
| 3 | `filling` | Domeo_Опции_Название_наполнения | Точное совпадение |
| 4 | `width` | Ширина/мм | Число |
| 5 | `height` | Высота/мм | 2350→2000, 2750→2000 (heightForFilter) |
| 6 | `finish` | Тип покрытия | **Сравнение без учёта регистра** (trim + toLowerCase) |
| 7 | `color` | Цвет/Отделка | Точное совпадение |

**Важно:** списки для селекторов (fillings, widths, heights, finishes, colorsByFinish, revers_available, mirror_available, threshold_available) собираются **после шагов 1–5**, но **до шагов 6–7**. Список кромок (edges) и флаг edge_in_base считаются **после шагов 6–7** по отфильтрованному набору.

---

## 3. Сбор опций (collectOptions)

В `lib/catalog/doors-model-options.ts` функция `collectOptions(products)` по массиву товаров собирает:

| Опция | Источник в properties | Примечание |
|-------|------------------------|------------|
| revers_available | Domeo_Опции_Реверс_доступен содержит «да» | Хотя бы у одного |
| fillings | Domeo_Опции_Название_наполнения | Уникальные непустые |
| widths | Ширина/мм | Уникальные > 0 |
| heights | Высота/мм | Уникальные > 0 |
| finishes | Тип покрытия | Уникальные непустые |
| colorsByFinish | Цвет/Отделка по ключу Тип покрытия | Группировка цветов по покрытию |
| edges | 1) Кромка (не пусто, не «-») 2) **Domeo_Кромка_базовая_цвет** и **Domeo_Кромка_Цвет_2/3/4** при Domeo_Кромка_в_базе_включена=да | Для Эмаль/ПВХ кромка часто только в Domeo_Кромка_* |
| mirror_available | Domeo_Опции_Зеркало_доступно содержит «да» | Хотя бы у одного |
| threshold_available | Domeo_Опции_Порог_доступен содержит «да» | Хотя бы у одного |

---

## 4. Подбор товара и расчёт цены (price engine)

В `lib/price/doors-price-engine.ts`:

### 4.1 Фильтр товаров (filterProducts)

Совпадение по: **Код модели Domeo (Web)**, **Domeo_Стиль Web**, **Тип покрытия**, **Цвет/Отделка**, Ширина/мм, Высота/мм (с маппингом 2350/2750→2000), **Domeo_Опции_Название_наполнения**, Поставщик (если передан).

- **Тип покрытия:** сравнение строк (рекомендуется согласовать с model-options: без учёта регистра).
- **Цвет:** точное совпадение; при отсутствии подходящих — fallback с allowEmptyColor (товары без Цвет/Отделка подходят под выбранный цвет).

### 4.2 Выбор одного товара

Из отфильтрованных берётся товар с **максимальной РРЦ** (pickMaxPriceProduct). У него берётся **Название модели** для корзины и экспорта.

### 4.3 Базовая цена и надбавки (breakdown)

| Элемент | Условие | Поле в БД / источник |
|---------|---------|----------------------|
| Дверь | Всегда | Цена РРЦ / Цена РРЦ (руб) / Цена розница / base_price |
| Надбавка 2301–2500 мм | height === 2350 | Domeo_Опции_Надбавка_2301_2500_процент (% от базы) |
| Надбавка 2501–3000 мм | height === 2750 | Domeo_Опции_Надбавка_2501_3000_процент (% от базы) |
| Реверс | selection.reversible | Domeo_Опции_Надбавка_реверс_руб |
| Зеркало одна сторона | mirror === 'one' \|\| 'mirror_one' | Domeo_Опции_Зеркало_одна_сторона_руб |
| Зеркало две стороны | mirror === 'both' \|\| 'mirror_both' | Domeo_Опции_Зеркало_две_стороны_руб |
| Порог | selection.threshold | Domeo_Опции_Цена_порога_руб |
| Кромка | edge_id и не «none» | Базовый цвет без наценки; Domeo_Кромка_Цвет_2/3/4 + Domeo_Кромка_Наценка_Цвет_2/3/4 |
| Комплект фурнитуры | hardware_kit.id | Категория «Комплекты фурнитуры»: Группа_цена / base_price |
| Ручка | handle.id | Категория «Ручки»: Domeo_цена группы Web / Цена продажи (руб) / base_price |
| Завертка | backplate === true при выбранной ручке | Завертка, цена РРЦ у ручки |
| Ограничитель | limiter_id | Товар по id: Цена РРЦ / base_price |
| Опции (наличники и т.д.) | option_ids | Товары по id: Цена РРЦ / base_price |

Итог: **total = roundUpTo100(сумма всех breakdown)**.

---

## 5. Связь UI → API

На странице `app/doors/page.tsx`:

- **modelOptionsParams:** reversible, filling, width, height, finish, color → уходят в useModelOptions → GET model-options.
- **Расчёт цены:** usePriceCalculation().calculate({ door_model_id, style, finish, color, width, height, edge_id, handle_id, limiter_id, hardware_kit_id, option_ids, reversible, mirror, threshold, filling, backplate, supplier }) → маппится в selection (model, handle: { id }, hardware_kit: { id }, …) → POST /api/price/doors.

Кромка в UI: список вариантов из **complete-data** (edge_options) фильтруется по **model-options.edges** (только те, что входят в allowed). Если edge_in_base и edges пустые для текущего набора — показывается только «Без кромки».

---

## 6. Чек-лист проверки (каждая опция)

- [ ] **Модель + стиль** — после выбора в model-options приходят только fillings/widths/heights/finishes для этой пары.
- [ ] **Реверс** — при включении реверса список товаров сужается (revers_available=true); в цене появляется надбавка «Реверс», если у выбранного товара заполнена Domeo_Опции_Надбавка_реверс_руб.
- [ ] **Наполнение** — фильтр по filling сужает набор; цена считается по товару с этим наполнением.
- [ ] **Ширина/высота** — только размеры из списка model-options; высоты 2350 и 2750 маппятся в 2000 при подборе товара; при 2350/2750 в breakdown есть надбавка за высоту, если в БД задан процент.
- [ ] **Тип покрытия** — сравнение без учёта регистра в model-options; в price engine желательно то же (или всегда передавать значение из modelOptionsData.finishes). После выбора покрытия список цветов — colorsByFinish[finish].
- [ ] **Цвет** — только цвета из colorsByFinish для выбранного покрытия; цена по товару с этим цветом (или allowEmptyColor fallback).
- [ ] **Кромка** — для Base 1 + Эмаль/ПВХ варианты кромки должны появляться (edges из Domeo_Кромка_* в collectOptions). В breakdown: базовая кромка 0, остальные — наценка из Domeo_Кромка_Наценка_Цвет_2/3/4.
- [ ] **Зеркало** — показ только при mirror_available; в breakdown «Зеркало (одна сторона)» или «Зеркало (две стороны)» по полям товара двери.
- [ ] **Порог** — показ только при threshold_available; в breakdown «Порог» по Domeo_Опции_Цена_порога_руб.
- [ ] **Комплект фурнитуры** — выбор из списка; в breakdown «Комплект: …» по Группа_цена/базовая цена комплекта.
- [ ] **Ручка** — в breakdown «Ручка: …»; при включённой завертке — «Завертка: …» по цене ручки.
- [ ] **Ограничитель** — в breakdown «Ограничитель: …» по цене товара ограничителя.
- [ ] **Опции (наличники и т.д.)** — option_ids передаются в price; в breakdown отдельная строка на каждую опцию по Цена РРЦ/base_price.
- [ ] **Итог** — total = округление вверх до 100 руб суммы всех строк breakdown.
- [ ] **model_name** — в ответе price и в корзине сохраняется Название модели выбранного (по макс. РРЦ) товара для экспорта в Excel.

---

## 7. Диагностика

- **model-options с debug:**  
  `GET /api/catalog/doors/model-options?model=...&style=...&width=...&height=...&debug=1`  
  В ответе массив **debugSteps**: после каждого фильтра — количество товаров и список типов покрытия. По нему видно, на каком шаге «пропадают» покрытия или цвета.

- **Согласованность полей:**  
  Значения, которые пользователь выбирает в UI (finish, color, filling), должны совпадать со значениями в БД (Тип покрытия, Цвет/Отделка, Domeo_Опции_Название_наполнения). Регистр для типа покрытия нормализован в model-options; в price engine при необходимости использовать ту же нормализацию.

---

## 8. Файлы для правок и тестов

| Компонент | Файл |
|-----------|------|
| Каскад фильтров и сбор опций | lib/catalog/doors-model-options.ts |
| API model-options | app/api/catalog/doors/model-options/route.ts |
| Расчёт цены | lib/price/doors-price-engine.ts |
| API price | app/api/price/doors/route.ts |
| complete-data (кромки каталога, опции модели) | app/api/catalog/doors/complete-data/route.ts |
| Калькулятор UI и вызов расчёта | app/doors/page.tsx |
| Маппинг параметров в selection | lib/configurator/useConfiguratorData.ts (usePriceCalculation) |
| Тесты фильтров и опций | lib/catalog/doors-model-options.test.ts |
| Тесты движка цен | lib/price/doors-price-engine.test.ts |
