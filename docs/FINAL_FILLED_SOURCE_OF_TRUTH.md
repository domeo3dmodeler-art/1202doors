# Источник истины: final_filled 30.01.xlsx

В БД для каталога дверей и смежных сущностей **единственный источник данных** — файл **final_filled 30.01.xlsx** (папка `1002/`). Импорт: `scripts/import-final-filled.ts`.

Все остальные поля и листы (в т.ч. старый импорт «02 Покрытия Цвета» из doors-import) считаются устаревшими и в БД не пишутся; уже записанные устаревшие ключи можно удалить скриптом `scripts/strip-legacy-coating-properties.ts`.

---

## Листы final_filled 30.01.xlsx и что попадает в БД

| Лист | Что импортируется |
|------|-------------------|
| **Цены базовые** | Товары дверей (Product): Код модели Domeo (Web), Название модели, Стиль, Поставщик, Высота/мм, Ширины/мм, Толщина/мм, Тип покрытия, Стекло, Кромка в базе, Цена опт, Цена РРЦ + разворот по размерам. Опции/стекло/кромка/поставщики цветов подтягиваются с других листов по «Название модели». |
| **Цвет** | PropertyPhoto (фото по вариантам цветов); значение = `Название модели|Тип покрытия|Цвет/отделка`. Колонки «Ссылка на обложку» и «Ссылки на галерею» — **только локальные пути** (внешние URL в конфигураторе не показываются). Путь относительно `public/uploads/`, например: `final-filled/doors/имя_файла.jpg`. Список поставщиков по цвету для модели → Domeo_Цвет_Поставщики в товарах. |
| **Опции** | По «Название модели»: наполнение, надбавки за высоту, реверс, порог, зеркало и т.д. → Domeo_Опции_* в properties_data товаров. |
| **Стекло_доступность** | Доступные цвета стекол и поставщики по модели → Domeo_Стекло_доступность, Domeo_Стекло_Поставщики. |
| **Наценка за кромку** | По «Название модели»: кромка в базе, опции кромки, наценки → Domeo_Кромка_* в properties_data. |
| **Наличики** | Товары наличников (Product). |
| **Фурнитура** | Комплекты фурнитуры (Product). |
| **04 Ручки Завертки** | Ручки и завертки (Product + properties). |
| **05 Ограничители** | Ограничители (Product). |

---

## Устаревшее (не используется, удалено из импорта)

- **Лист «02 Покрытия Цвета»** (шаблон newdata.xlsx / doors-import) — раньше писал в Product: `Domeo_Код покрытия`, `Domeo_Название цвета`, `Domeo_Цвет HEX`, `Это шпон`, `Покрытие: Цена опт (руб)`, `Покрытие: Цена РРЦ (руб)`, `Покрытие: Порядок сортировки`, `Покрытие: Активен`. Импорт этого листа в `DoorsImportService` отключён; эти ключи в БД больше не записываются.
- Очистка уже записанных устаревших полей:  
  `npx tsx scripts/strip-legacy-coating-properties.ts` (без флага — запись в БД; с `--dry-run` — только отчёт).

Цвет для подбора товара и экспорта задаётся только полем **Цвет/Отделка** в `properties_data` (см. DOOR_COLORS_IN_CATALOG.md).

---

## Фото моделей и цветов (локальные)

Все фото лежат в **`public/uploads/`** (в т.ч. `public/uploads/final-filled/doors/`). API complete-data отдаёт только локальные пути; внешние URL отбрасываются. В листе «Цвет» в колонках «Ссылка на обложку» и «Ссылки на галерею (через ;)» указывайте пути вида **`final-filled/doors/файл.jpg`** — они раздаются по адресу `/api/uploads/final-filled/doors/файл.jpg`. После изменения путей в Excel запустите импорт заново.

Раздача (`/api/uploads/[...path]`): если файл не найден по запрошенному пути, для папки `final-filled/doors/` дополнительно проверяются: вариант с/без суффикса `_cover`; расширение `.jpg`/`.png`; вариант с префиксом **`Дверное_полотно_`**; **fallback по модели** — если для запрошенного покрытия/цвета файла нет, ищется любой файл с тем же префиксом модели (например для Galaxy 1 в БД «Дверное полотно A-Line 1 ПО кр.», запрос идёт по «ПО кр.»+цвет; файл есть только для «ПО Алюминий»+«Черный» — отдаётся он).

### Проблемные модели (нет файлов в папке doors)

В `public/uploads/final-filled/doors/` **отсутствуют** файлы для ряда моделей. Пока файлов нет, в конфигураторе для них показываются плейсхолдеры («PHOTO NOT AVAILABLE» или серый блок с названием модели). Проверено отсутствие файлов для: **Ledoux 1, Ledoux 2, Ruby 1, Gabriel 2–5**, **Comet 3**, **Nebula 1, Nebula 3** (и возможно другие). **Galaxy 1–5** в БД соответствуют названиям **«Дверное полотно A-Line 1/2/3/4/8 ПО кр.»**; фото ищем по этому названию. В папке есть только файлы для варианта «ПО Алюминий» + «Черный (RAL 9005)»; при отсутствии точного файла раздача подставляет любое фото той же модели (fallback по префиксу). **Nebula 1 / Nebula 3** соответствуют **«Дверное полотно TITANIUM 10/2 ПО иск.п.»** и **«Дверное полотно TITANIUM 10/1 ПО иск.п.»**; в именах файлов слэш в номере (10/2, 10/1) при формировании пути заменяется на подчёркивание (10_2, 10_1). Файлы TITANIUM есть в папке doors (ПВХ + цвета).

Чтобы фото отображались, добавьте файлы в эту папку. Имена могут быть в одном из форматов (оба поддерживаются):

- **Без префикса** (как генерирует fallback API):  
  `{Название_модели}_{Тип_покрытия}_{Цвет}_cover.png`  
  Пример: `Ledoux_1_ПГ_кр._Эмаль_Белоснежный_cover.png`, `Ruby_1_ПГ_кр._Эмаль_Белоснежный_cover.png`, `Gabriel_2_..._cover.png`.
- **С префиксом** (как у многих уже лежащих файлов):  
  `Дверное_полотно_{Название_модели}_{Тип_покрытия}_{Цвет}_cover.png`  
  Пример: `Дверное_полотно_Ledoux_1_ПГ_кр._Эмаль_Белоснежный_cover.png`.

Название модели, тип покрытия и цвет берутся из БД (лист «Цвет» / товары); пробелы в имени файла заменяются на `_`, допустимы точка и скобки (напр. `ПГ_кр.`, `RAL_7047`). После добавления файлов откройте `/doors?refresh=1` для сброса кэша complete-data.
