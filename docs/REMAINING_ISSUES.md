# Оставшиеся проблемы — решения зафиксированы

Ниже — статус по каждому пункту после решений продукта и доработок.

---

## 1. Высота 2301–2500 / 2501–3000 в экспорте — исправлено

**Было:** В product-match высота сравнивалась «как есть» (2350/2750), в БД у товаров 2000 → не было совпадения.

**Решение:** Высоты 2350 и 2750 — **виртуальные** для интервалов 2301–2500 и 2501–3000; в БД у товаров хранится 2000. В `lib/catalog/product-match.ts` в `findDoorsByConfiguration()` добавлен маппинг: при сравнении высоты 2350 и 2750 приводятся к 2000 (как в price-engine). Совпадение по высоте теперь корректное.

---

## 2. Покрытия из complete-data — исправлено

**Решение:** Каноническое поле цвета — **Цвет/Отделка** (Domeo_Цвет устарел). В complete-data после PropertyPhoto добавлен проход по товарам модели: уникальные пары (Тип покрытия, Цвет/Отделка) из products дополняют coatings. В product-match и экспорте цвет берётся из Цвет/Отделка.

---

## 3. Кэш complete-data (30 мин) — решение

**Решение:** Документировать сброс кэша после импорта (DELETE с авторизацией или ?refresh=1). При импорте через API/скрипт — в конце операции вызывать сброс кэша. Подробности в DATA_AND_CACHE_RECOMMENDATIONS.md.

---

## 4. Fallback при экспорте

**Решение:** Калькулятор работает строго на данных из БД; при корректных данных совпадение должно быть всегда. Fallback оставлен для устойчивости (старые заказы, сбои). При срабатывании fallback пишется предупреждение в лог с контекстом (itemName, itemModel, finish, color и т.д.), чтобы отслеживать случаи.

---

## 5. Дублирование ключей в properties_data — канонические поля

**Решение:** Зафиксированы канонические ключи для дверей:
- **Тип покрытия** — тип покрытия (не «Материал/Покрытие» для подбора).
- **Цвет/Отделка** — цвет (Domeo_Цвет устарел).
- **Ширина/мм**, **Высота/мм** — размеры (Размер 1 / Размер 2 переименовать в импорте/схеме при необходимости в канонические имена).

В product-match и price-engine подбор по модели только по **Код модели Domeo (Web)** (Артикул поставщика не используется).

---

## 6. Товары только с «Артикул поставщика»

**Решение:** Параметр «Артикул поставщика» — устаревший, в текущей логике не используется. Группировка и подбор только по **Код модели Domeo (Web)**.

---

## 7. Обложки моделей

**Решение:** Берём **первое фото из «Цвет»** (PropertyPhoto) для данного кода модели. Логика в complete-data: первое фото из цветов по коду/фабричному названию используется как обложка.

---

## 8. Надбавки за реверс/зеркало/порог

**Решение:** При разных значениях у товаров одной модели брать **максимум**. В complete-data и price/doors уже используется Math.max для надбавок.

---

## 9. Кромка по модели — данные могут быть разные

**Решение:** Опции кромки собираются по **всем товарам модели** (объединение): уникальные варианты (id, name, surcharge), при одном и том же цвете с разной наценкой берётся максимальная наценка. В complete-data реализовано через edgeOptionsMap по всем products.

---

## 10. Цвета в UI

**Решение:** **Общий список** цветов по модели (без разделения по фабричным названиям). Оставлено как есть.

---

## Уже исправлено ранее (для контекста)

- Два конфигуратора — оставлен только `/doors`.
- Два разных поиска в экспорте — единый модуль `lib/catalog/product-match.ts`.
- Корзина: finish/color из БД (getCoatingForCart).
- «Название модели» в Excel — только `props['Название модели']` при найденном товаре.
- Ручки/завертки: findHandleById, категории «Ручки» и «Ручки и завертки».
- Тип конструкции — не используется, убран из фильтра. Звукоизоляция (Стандартное/Хорошее/Отличное) — убрана из UI.
