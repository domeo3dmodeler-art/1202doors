# Список проблем, выявленных при аудите калькулятора

Источники: CALCULATOR_FULL_AUDIT.md, CONFIGURATOR_FILTERS_AUDIT (архив), CONFIGURATOR_FIX_PLAN (архив).

---

## 1. Проблемы, которые были выявлены и исправлены

| № | Проблема | Что сделано |
|---|----------|-------------|
| 1 | **Цена не учитывала наполнение (filling)** — при выборе «Голд» цена могла считаться по товару с наполнением «Сильвер» | В selection передаётся `filling`, в price/doors добавлен фильтр по `Domeo_Опции_Название_наполнения` |
| 2 | **При высотах 2301–2500 и 2501–3000 model-options возвращал пустой каскад** — в БД нет высот 2350/2750, фильтр ничего не находил | В model-options для фильтра при height 2350/2750 подставляется 2000 |
| 3 | **Выбранная модель не сбрасывалась при сужении фильтров** — после смены наполнения на «Голд» в списке могла остаться модель без Голд | useEffect сбрасывает selectedModelId на первую модель из filteredModels, если текущая выпала из списка |
| 4 | **Дефолтный стиль «Современные» мог отсутствовать в данных** — тогда список моделей пустой | Инициализация selectedStyle из availableStyles[0] при первой загрузке |
| 5 | **Два смысла «наполнение» в UI** — каталоговое (Голд/Сильвер) и звукоизоляция (Стандартное/Хорошее/Отличное) | В спецификации разделены «Наполнение (каталог)» и «Звукоизоляция»; для цены используется только каталоговое |
| 6 | **Цена не обновлялась при смене модели** — «прилипала» старая цена | Сброс цены при смене modelId; расчёт только при selectedModelData?.id === selectedModelId; игнор устаревших ответов (request id) |
| 7 | **Цена не обновлялась при смене покрытия/цвета** | Сброс цены при смене coatingKey; зависимость эффекта расчёта от coatingKey |
| 8 | **Кромка: при недоступности показывалось «Без кромки»** | При отсутствии вариантов кромки показывается «Кромка не доступна» |

---

## 2. Оставшиеся / требующие внимания

### 2.1 Исправлено по решению продукта

- **Тип конструкции** — не используется, в БД параметра нет. Убран из фильтра price/doors (typeMatch удалён).
- **Звукоизоляция (Стандартное/Хорошее/Отличное)** — устаревшие данные. Удалены из UI: state filling (standard/good/excellent), блок fillingOptions, getFillingText. В расчёте и корзине не участвуют. В спецификации остаётся только «Наполнение (каталог)» (Голд, Сильвер и т.д.).

### 2.2 Данные и согласованность

- **Покрытия из complete-data** — могут строиться из PropertyPhoto (лист «Цвет»). Если там расхождение с полями товаров (Тип покрытия, Domeo_Цвет), в корзину попадёт значение, по которому при расчёте цены или экспорте товар не найдётся. Рекомендация: формировать coatings из products или верифицировать соответствие PropertyPhoto и БД.
- **Кэш complete-data 30 мин** — после обновления каталога пользователь до 30 минут может видеть старые данные без сброса кэша.

### 2.3 Верификация

Проверочный список из CALCULATOR_FULL_AUDIT (раздел 6) — стоит периодически проверять вручную или автотестами:

- При смене стиля список моделей меняется; выбранная модель сбрасывается при выпадении из списка.
- При выборе «Голд» показываются только модели с Голд; цена считается по товару с наполнением Голд.
- При высотах 2301–2500 / 2501–3000 каскад model-options не пустой; цена считается с надбавкой за высоту при заданных процентах в товаре.
- При смене модели цена сбрасывается и показывается расчёт для новой модели.
- При смене покрытия/цвета цена пересчитывается.
- При включении реверса надбавка добавляется в breakdown и total.
- Кромка с наценкой отображается в breakdown; при недоступности — «Кромка не доступна».
- В корзину попадают priceData.total, priceData.sku и параметры, соответствующие текущему выбору.

---

## 3. Проблемы, выявленные аудитом 2026-02-15 (CALCULATOR_DATA_FLOW_AUDIT)

Полный разбор: **CALCULATOR_DATA_FLOW_AUDIT.md**.

| № | Проблема | Что сделано |
|---|----------|-------------|
| 1 | **Одна запись на код модели и один стиль** — при вызове complete-data без `style` в ответе одна запись на modelKey со стилем первого товара; при выборе другого стиля в UI модель (напр. Base 1) исчезала | В complete-data при отсутствии `style`: возвращаем по одной записи на (modelKey, style). Наполнение по коду — по всем товарам (fillingByModelKey). |
| 2 | **Наполнение не для всех моделей кода** — filling_names собирался только по товарам, отфильтрованным по стилю | Отдельный проход по всем товарам → fillingByModelKey; в ответе filling_names из этой карты (уже внедрено ранее). |
| 3 | **Выбор модели при двух записях с одним modelKey** — useModelDetails находил первую запись по modelKey, а не по стилю | useModelDetails(modelId, rawModels, selectedStyle); поиск по modelKey и selectedStyle; в списке карточек key = `${id}-${style}`. |

## 4. Связанные документы

- **CALCULATOR_DATA_FLOW_AUDIT.md** — полный аудит использования данных: связи, фильтры, влияния, критические проблемы (2026-02-15)
- **CALCULATOR_FULL_AUDIT.md** — полное описание источников данных, движка расчёта, цепочек и согласованности
- **REMAINING_ISSUES.md** — общие оставшиеся проблемы (в т.ч. высота в экспорте, fallback)
- **HEIGHT_MARKUP_FIELDS.md** — надбавки за высоту 2301–2500 / 2501–3000, поля БД, округление
