# Остановить приложение, убить подозрительные процессы (logic.sh, 91.92.243.113), удалить logic.sh, перезапустить.
# Запуск: .\scripts\vm-cleanup-malware-and-restart.ps1

$ErrorActionPreference = "Stop"
$KeyPath = if ($env:1002DOORS_SSH_KEY) { $env:1002DOORS_SSH_KEY } else { "C:\Users\petr2\.ssh\ssh-key-1771526730154\ssh-key-1771526730154" }
$StagingHost = if ($env:1002DOORS_STAGING_HOST) { $env:1002DOORS_STAGING_HOST } else { "ubuntu@89.169.181.191" }
$SshOpts = @("-o", "StrictHostKeyChecking=no", "-o", "ServerAliveInterval=15", "-o", "ConnectTimeout=15")

Write-Host "Stopping app and cleaning suspicious processes on VM..." -ForegroundColor Cyan
$cleanCmd = "sudo systemctl stop domeo-standalone 2>/dev/null; true; pkill -f logic.sh 2>/dev/null; true; pkill -f '91.92.243' 2>/dev/null; true; sudo find /home -name logic.sh -delete 2>/dev/null; true; sleep 2; sudo systemctl start domeo-standalone 2>/dev/null; true; sleep 3; systemctl is-active domeo-standalone 2>/dev/null; ss -tlnp 2>/dev/null | grep 3000 || true"
& ssh -i $KeyPath @SshOpts $StagingHost $cleanCmd 2>&1
Write-Host "Done. Check: .\scripts\diagnose-502-on-vm.ps1" -ForegroundColor Green
